@page "/results"
@using PoFunQuiz.Client
@using PoFunQuiz.Core.Services
@using Radzen
@using Radzen.Blazor
@inject NavigationManager Navigation
@inject PoFunQuiz.Client.GameState GameState
@rendermode InteractiveWebAssembly

<PageTitle>PoFunQuiz - Results</PageTitle>

@if (GameState.CurrentGame == null)
{
    <div class="rz-display-flex rz-flex-column rz-align-items-center rz-justify-content-center" style="height: 85vh;">
        <RadzenText TextStyle="TextStyle.H4" class="rz-mb-4">No game results available.</RadzenText>
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Path="/">Return to Main Menu</RadzenButton>
    </div>
}
else
{
    <div class="rz-p-sm-4 rz-p-2">
        <RadzenCard class="rz-p-4 rz-p-sm-6">
            <RadzenText TextStyle="TextStyle.H4" TextAlign="TextAlign.Center" class="rz-mb-4">Game Results</RadzenText>

            @if (WinnerDeclared)
            {
                <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Radzen.Variant.Filled" Shade="Shade.Lighter" AllowClose="false" class="rz-my-3">
                    <RadzenText TextStyle="TextStyle.H6">
                        @if (IsTie)
                        {
                            <span>It's a Tie!</span>
                        }
                        else
                        {
                            <span>Winner: Player @WinnerNumber (@(Winner?.Initials ?? "???")) - Congratulations!</span>
                        }
                    </RadzenText>
                </RadzenAlert>
            }

            <RadzenRow Gutters="true" class="rz-mt-3">
                <!-- Player 1 Results -->
                <RadzenColumn Size="12" SizeMD="6" class="rz-mb-3 rz-mb-md-0">
                    <RadzenCard class="rz-p-2 rz-p-sm-4" style="height: 100%;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" class="rz-mb-3">
                            <RadzenAvatar Color="AvatarColor.Primary" class="rz-mr-2" Size="AvatarSize.Small" Text="@(GameState.CurrentGame?.Player1?.Initials ?? "P1")" />
                            <RadzenText TextStyle="TextStyle.H6">Player 1</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="question_answer" />
                                <RadzenText TextStyle="TextStyle.Body2">Questions: @GetQuestionsAnswered(1) of 5</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="check" />
                                <RadzenText TextStyle="TextStyle.Body2">Correct: @GetCorrectAnswers(1)</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="close" />
                                <RadzenText TextStyle="TextStyle.Body2">Incorrect: @(GetQuestionsAnswered(1) - GetCorrectAnswers(1))</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="speed" />
                                <RadzenText TextStyle="TextStyle.Body2">Speed Bonus: +@GetSpeedBonus(1) points</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="whatshot" />
                                <RadzenText TextStyle="TextStyle.Body2">Streak Bonus: +@GetStreakBonus(1) points</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="timer" />
                                <RadzenText TextStyle="TextStyle.Body2">Time Bonus: +@GetTimeBonus(1) points</RadzenText>
                            </RadzenStack>
                            <RadzenDivider class="rz-my-2" />
                            <RadzenText TextStyle="TextStyle.H6">Total Score: @(GameState.CurrentGame?.Player1Score ?? 0) points</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>

                <!-- Player 2 Results -->
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenCard class="rz-p-2 rz-p-sm-4" style="height: 100%;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" class="rz-mb-3">
                            <RadzenAvatar Color="AvatarColor.Secondary" class="rz-mr-2" Size="AvatarSize.Small" Text="@(GameState.CurrentGame?.Player2?.Initials ?? "P2")" />
                            <RadzenText TextStyle="TextStyle.H6">Player 2</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="question_answer" />
                                <RadzenText TextStyle="TextStyle.Body2">Questions: @GetQuestionsAnswered(2) of 5</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="check" />
                                <RadzenText TextStyle="TextStyle.Body2">Correct: @GetCorrectAnswers(2)</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="close" />
                                <RadzenText TextStyle="TextStyle.Body2">Incorrect: @(GetQuestionsAnswered(2) - GetCorrectAnswers(2))</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="speed" />
                                <RadzenText TextStyle="TextStyle.Body2">Speed Bonus: +@GetSpeedBonus(2) points</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="whatshot" />
                                <RadzenText TextStyle="TextStyle.Body2">Streak Bonus: +@GetStreakBonus(2) points</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="timer" />
                                <RadzenText TextStyle="TextStyle.Body2">Time Bonus: +@GetTimeBonus(2) points</RadzenText>
                            </RadzenStack>
                            <RadzenDivider class="rz-my-2" />
                            <RadzenText TextStyle="TextStyle.H6">Total Score: @(GameState.CurrentGame?.Player2Score ?? 0) points</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>

                <!-- Game Statistics -->
                <RadzenColumn Size="12" class="rz-mt-3">
                    <RadzenCard class="rz-p-2 rz-p-sm-4" Variant="Radzen.Variant.Outlined">
                        <RadzenText TextStyle="TextStyle.Subtitle2">Game Statistics</RadzenText>
                        <RadzenRow Gutters="true">
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenText TextStyle="TextStyle.Caption">Game Duration: @GetGameDuration()</RadzenText>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenText TextStyle="TextStyle.Caption">Total Questions: 20</RadzenText>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenText TextStyle="TextStyle.Caption">Total Correct: @(GetCorrectAnswers(1) + GetCorrectAnswers(2))</RadzenText>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenText TextStyle="TextStyle.Caption">Game ID: @(GameState.CurrentGame?.GameId?.Substring(0, 8) ?? "N/A")</RadzenText>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="2" class="rz-mt-4 rz-flex-wrap">
                <RadzenButton ButtonStyle="ButtonStyle.Primary"
                              Size="ButtonSize.Small"
                              Click="@PlayAgain"
                              Text="PLAY AGAIN" />
                <RadzenButton ButtonStyle="ButtonStyle.Light"
                              Shade="Shade.Lighter"
                              Size="ButtonSize.Small"
                              Path="/leaderboard"
                              Text="VIEW LEADERBOARD" />
                <RadzenButton Variant="Variant.Text"
                              Shade="Shade.Lighter"
                              Size="ButtonSize.Small"
                              Path="/"
                              Text="MAIN MENU" />
            </RadzenStack>
        </RadzenCard>
    </div>
}

<style>
    /* Keep responsive styles if needed, adjust for Radzen classes if necessary */
    @@media (max-width: 600px) {
        .rz-card { /* Example: if RadzenCard needs specific padding on mobile */
            padding: 0.5rem !important;
        }
        .rz-card .rz-p-2, .rz-card .rz-p-sm-4 { /* More specific if nested cards */
             padding: 0.5rem !important;
        }
        /* .rz-list-item was an example, RadzenStack is used instead, so this might not be needed */
        /* If RadzenList or similar were used, this would be relevant:
        .rz-list-item { 
            padding-top: 4px !important;
            padding-bottom: 4px !important;
        }
        */
    }
</style>

@code {
    private bool WinnerDeclared => GameState.CurrentGame?.Player1Score != null && GameState.CurrentGame?.Player2Score != null;
    private bool IsTie => WinnerDeclared && GameState.CurrentGame?.Player1Score == GameState.CurrentGame?.Player2Score;
    private int WinnerNumber => (!WinnerDeclared || IsTie) ? 0 : (GameState.CurrentGame?.Player1Score > GameState.CurrentGame?.Player2Score ? 1 : 2);
    private Core.Models.Player? Winner => WinnerNumber == 1 ? GameState.CurrentGame?.Player1 : (WinnerNumber == 2 ? GameState.CurrentGame?.Player2 : null);

    protected override Task OnInitializedAsync()
    {
        if (GameState.CurrentGame == null)
        {
            Navigation.NavigateTo("/");
            return Task.CompletedTask;
        }
        UpdatePlayerStatisticsAsync();
        return Task.CompletedTask;
    }

    private int GetCorrectAnswers(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0;
        
        // Return the actual base score which represents correct answers (1 point each)
        return playerNumber == 1 
            ? GameState.CurrentGame.Player1BaseScore 
            : GameState.CurrentGame.Player2BaseScore;
    }

    private int GetTimeBonus(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0;
        
        // Return the actual time bonus calculated during the game
        return playerNumber == 1
            ? GameState.CurrentGame.Player1TimeBonus
            : GameState.CurrentGame.Player2TimeBonus;
    }

    private int GetQuestionsAnswered(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0;
        
        // Return the actual base score which represents questions answered correctly
        return playerNumber == 1 
            ? GameState.CurrentGame.Player1BaseScore 
            : GameState.CurrentGame.Player2BaseScore;
    }

    private int GetSpeedBonus(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0;
        
        // Return the actual speed bonus calculated during the game
        return playerNumber == 1
            ? GameState.CurrentGame.Player1SpeedBonus
            : GameState.CurrentGame.Player2SpeedBonus;
    }

    private int GetStreakBonus(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0;
        
        // Return the actual streak bonus calculated during the game
        return playerNumber == 1
            ? GameState.CurrentGame.Player1StreakBonus
            : GameState.CurrentGame.Player2StreakBonus;
    }

    private string GetGameDuration()
    {
        if (GameState.CurrentGame?.StartTime.HasValue == true && GameState.CurrentGame?.EndTime.HasValue == true)
        {
            var duration = GameState.CurrentGame.EndTime.Value - GameState.CurrentGame.StartTime.Value;
            return $"{duration.Minutes:D2}:{duration.Seconds:D2}";
        }
        return "00:00";
    }

    private void PlayAgain()
    {
        if (GameState.CurrentGame?.Player1 == null || GameState.CurrentGame?.Player2 == null)
        {
            Navigation.NavigateTo("/");
            return;
        }
        var player1 = GameState.CurrentGame.Player1;
        var player2 = GameState.CurrentGame.Player2;
        GameState.CurrentGame = new Core.Models.GameSession
        {
            Player1 = player1,
            Player2 = player2,
            StartTime = DateTime.UtcNow,
            GameId = Guid.NewGuid().ToString()
        };
        Navigation.NavigateTo("/game-setup");
    }

    private void UpdatePlayerStatisticsAsync()
    {
        if (GameState.CurrentGame?.Player1 == null || GameState.CurrentGame?.Player2 == null)
        {
            Console.WriteLine($"Error updating player statistics: CurrentGame or Players are null.");
            return;
        }
        try
        {
            bool player1IsWinner = WinnerNumber == 1;
            bool player2IsWinner = WinnerNumber == 2;
            int player1Score = GameState.CurrentGame.Player1Score;
            int player2Score = GameState.CurrentGame.Player2Score;
            UpdatePlayerStats(GameState.CurrentGame.Player1, player1IsWinner, GetCorrectAnswers(1), player1Score);
            UpdatePlayerStats(GameState.CurrentGame.Player2, player2IsWinner, GetCorrectAnswers(2), player2Score);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating player statistics: {ex.Message}");
        }
    }

    private void UpdatePlayerStats(Core.Models.Player? player, bool isWinner, int correctAnswers, int totalScore)
    {
        if (player == null) return;
        player.GamesPlayed++;
        if (isWinner) player.GamesWon++;
        player.TotalScore += totalScore;
        player.TotalCorrectAnswers += correctAnswers;
        // await PlayerService.UpdatePlayerAsync(player); // Server-side call removed
    }
}
