@page "/diag"
@inject NavigationManager NavigationManager
@inject ILogger<Diag> Logger
@inject HttpClient HttpClient

<PageTitle>PoFunQuiz - Diagnostics</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">System Diagnostics</h1>

    @if (_isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Checking system health...</p>
        </div>
    }
    else if (_healthReport != null)
    {
        <div class="alert @GetOverallStatusClass() mb-4" role="alert">
            <h5>Overall Status: @_healthReport.Status</h5>
            <small>Last checked: @_healthReport.Timestamp.ToLocalTime().ToString("g")</small>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
            @foreach (var check in _healthReport.Checks)
            {
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                @if (check.Status == "Healthy")
                                {
                                    <span class="text-success me-2">✅</span>
                                }
                                else if (check.Status == "Degraded")
                                {
                                    <span class="text-warning me-2">⚠️</span>
                                }
                                else
                                {
                                    <span class="text-danger me-2">❌</span>
                                }
                                <h5 class="card-title mb-0">@FormatCheckName(check.Name)</h5>
                            </div>
                            @if (!string.IsNullOrEmpty(check.Description))
                            {
                                <p class="card-text mt-2 @GetStatusClass(check.Status)">
                                    @check.Description
                                </p>
                            }
                            @if (check.Duration > 0)
                            {
                                <small class="text-muted">Duration: @check.Duration ms</small>
                            }
                            @if (!string.IsNullOrEmpty(check.Exception))
                            {
                                <div class="mt-2">
                                    <small class="text-danger">Error: @check.Exception</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <h5>Error Loading Health Status</h5>
            <p>@_errorMessage</p>
        </div>
    }

    <hr class="my-4" />

    <div class="d-flex gap-2">
        <button class="btn btn-primary" @onclick="LoadHealthStatus" disabled="@_isLoading">
            @(_isLoading ? "Checking..." : "Refresh Status")
        </button>

        <button class="btn btn-outline-secondary" @onclick="@(() => NavigationManager.NavigateTo("/"))">
            Back to Home
        </button>
    </div>
</div>

@code {
    private bool _isLoading = true;
    private HealthReport? _healthReport;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadHealthStatus();
    }

    private async Task LoadHealthStatus()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            Logger.LogInformation("Loading health status from /api/health");

            var response = await HttpClient.GetAsync("/api/health");
            var content = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.ServiceUnavailable)
            {
                _healthReport = System.Text.Json.JsonSerializer.Deserialize<HealthReport>(
                    content,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                Logger.LogInformation("Health status loaded successfully");
            }
            else
            {
                _errorMessage = $"Failed to load health status: {response.ReasonPhrase}";
                Logger.LogWarning("Failed to load health status: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading health status: {ex.Message}";
            Logger.LogError(ex, "Error loading health status");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string FormatCheckName(string name)
    {
        return name switch
        {
            "table_storage" => "Table Storage",
            "openai" => "Azure OpenAI",
            "internet" => "Internet Connectivity",
            _ => name.Replace("_", " ").ToUpper()
        };
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Healthy" => "text-success",
            "Degraded" => "text-warning",
            "Unhealthy" => "text-danger",
            _ => "text-muted"
        };
    }

    private string GetOverallStatusClass()
    {
        return _healthReport?.Status switch
        {
            "Healthy" => "alert-success",
            "Degraded" => "alert-warning",
            "Unhealthy" => "alert-danger",
            _ => "alert-info"
        };
    }

    private class HealthReport
    {
        public string Status { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public List<HealthCheck> Checks { get; set; } = new();
    }

    private class HealthCheck
    {
        public string Name { get; set; } = "";
        public string Status { get; set; } = "";
        public string? Description { get; set; }
        public double Duration { get; set; }
        public string? Exception { get; set; }
    }
}

