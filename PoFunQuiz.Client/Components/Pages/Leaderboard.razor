@page "/leaderboard"
@using PoFunQuiz.Core.Models
@using PoFunQuiz.Core.Services
@using Microsoft.Extensions.Logging
@using Radzen
@using Radzen.Blazor
@inject NavigationManager Navigation
@inject ILogger<Leaderboard> Logger
@inject IJSRuntime JSRuntime
@rendermode InteractiveWebAssembly

<PageTitle>PoFunQuiz - Leaderboard</PageTitle>

<div class="rz-p-1 rz-p-sm-4">
    <RadzenCard class="rz-p-2 rz-p-sm-4">
        <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center" class="rz-mb-2">Leaderboard</RadzenText>

        @if (Loading)
        {
            <div class="rz-display-flex rz-justify-content-center rz-my-2">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 100px; height: 20px;" />
            </div>
        }
        else if (ErrorMessage != null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Radzen.Variant.Flat" Shade="Shade.Lighter" AllowClose="false" class="rz-my-2">@ErrorMessage</RadzenAlert>
            <div class="rz-display-flex rz-flex-column rz-align-items-center">
                <RadzenButton ButtonStyle="ButtonStyle.Primary"
                              Click="LoadLeaderboard"
                              Size="ButtonSize.Small"
                              class="rz-my-2"
                              Text="RETRY" />
            </div>
        }
        else if (Players.Count == 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Radzen.Variant.Flat" Shade="Shade.Lighter" AllowClose="false" class="rz-my-2">
                No player data available yet. Play some games to populate the leaderboard!
            </RadzenAlert>
        }
        else
        {
            <!-- Individual Player Statistics -->
            <RadzenText TextStyle="TextStyle.H6" TextAlign="TextAlign.Center" class="rz-mb-3">Player Leaderboard & Statistics</RadzenText>
            <RadzenDataGrid AllowFiltering="false" AllowPaging="false" AllowSorting="true" Data="@Players" TItem="Player" class="leaderboard-table" Responsive="true">
                <Columns>
                    <RadzenDataGridColumn TItem="Player" Property="Rank" Title="Rank" Width="70px" TextAlign="TextAlign.Center">
                        <Template Context="player">
                            @if (player.Rank <= 3)
                            {
                                <RadzenIcon Icon="emoji_events" Style="@($"color: {GetRankColorString(player.Rank)}; font-size: 1.2em;")" />
                            }
                            @player.Rank
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Player" Property="Initials" Title="Player" Width="100px">
                        <Template Context="player">
                            <RadzenBadge Text="@player.Initials" BadgeStyle="@GetPlayerBadgeStyle(player.Rank)" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Player" Property="GamesPlayed" Title="Games" Width="80px" TextAlign="TextAlign.Right" />
                    <RadzenDataGridColumn TItem="Player" Property="GamesWon" Title="Wins" Width="80px" TextAlign="TextAlign.Right" />
                    <RadzenDataGridColumn TItem="Player" Property="TotalScore" Title="Score" Width="100px" TextAlign="TextAlign.Right" />
                    <RadzenDataGridColumn TItem="Player" Title="Win %" Width="80px" TextAlign="TextAlign.Right" FormatString="{0:P0}">
                        <Template Context="player">
                            @((double)player.GamesWon / Math.Max(1, player.GamesPlayed))
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Player" Title="Avg Score" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:F1}">
                         <Template Context="player">
                            @((double)player.TotalScore / Math.Max(1, player.GamesPlayed))
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Player" Property="TotalCorrectAnswers" Title="Correct" Width="80px" TextAlign="TextAlign.Right" />
                    <RadzenDataGridColumn TItem="Player" Title="Accuracy" Width="100px" TextAlign="TextAlign.Right" FormatString="{0:P0}">
                        <Template Context="player">
                           @((double)player.TotalCorrectAnswers / (Math.Max(1, player.GamesPlayed) * 10))
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- Global Statistics -->
            <RadzenDivider class="rz-my-4" />
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-2">Global Statistics</RadzenText>

            <RadzenRow Gutters="true">
                <RadzenColumn Size="12" SizeMD="6" class="rz-mb-3 rz-mb-md-0">
            <RadzenCard Variant="Variant.Outlined" class="rz-p-3">
                        <RadzenText TextStyle="TextStyle.Subtitle2">Questions Summary</RadzenText>
                        <RadzenStack Gap="0">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="question_answer" />
                                <RadzenText TextStyle="TextStyle.Body2">Total Questions Asked: @TotalQuestionsAsked</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="check" />
                                <RadzenText TextStyle="TextStyle.Body2">Total Correct Answers: @TotalCorrectAnswers</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="percent" />
                                <RadzenText TextStyle="TextStyle.Body2">Overall Accuracy: @($"{OverallAccuracy:P1}")</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Variant="Variant.Outlined" class="rz-p-3">
                        <RadzenText TextStyle="TextStyle.Subtitle2">Game Summary</RadzenText>
                        <RadzenStack Gap="0">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="sports_esports" />
                                <RadzenText TextStyle="TextStyle.Body2">Total Games Played: @TotalGamesPlayed</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="access_time" />
                                <RadzenText TextStyle="TextStyle.Body2">Average Game Duration: @AverageGameDuration</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1" class="rz-py-1">
                                <RadzenIcon Icon="emoji_people" />
                                <RadzenText TextStyle="TextStyle.Body2">Total Players: @Players.Count</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>

            <!-- Daily Activity Charts -->
            <RadzenDivider class="rz-my-4" />
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-2">Daily Activity</RadzenText>
            
            <RadzenCard Variant="Variant.Outlined" class="rz-p-3 rz-mb-3">
                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Games Played Per Day</RadzenText>
                <div class="chart-container">
                    @foreach (var dayData in GamesPlayedPerDay.OrderBy(d => d.Key))
                    {
                        var barHeight = Math.Max(20, Math.Min(100, dayData.Value * 10)); // Scale factor
                        <div class="chart-item">
                            <div class="chart-bar" style="height: @(barHeight)px; background-color: var(--rz-primary-dark);">
                                <span class="chart-value">@dayData.Value</span>
                            </div>
                            <div class="chart-label">@FormatDayLabel(dayData.Key)</div>
                        </div>
                    }
                </div>
            </RadzenCard>
            
            <RadzenCard Variant="Variant.Outlined" class="rz-p-3 rz-mb-3">
                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Questions Asked Per Day</RadzenText>
                <div class="chart-container">
                    @foreach (var dayData in QuestionsAskedPerDay.OrderBy(d => d.Key))
                    {
                        var barHeight = Math.Max(20, Math.Min(100, dayData.Value * 2)); // Adjusted scale factor
                        <div class="chart-item">
                            <div class="chart-bar" style="height: @(barHeight)px; background-color: var(--rz-secondary-dark);">
                                <span class="chart-value">@dayData.Value</span>
                            </div>
                            <div class="chart-label">@FormatDayLabel(dayData.Key)</div>
                        </div>
                    }
                </div>
            </RadzenCard>
        }
        
        <div class="rz-display-flex rz-justify-content-center rz-mt-3">
            <RadzenButton ButtonStyle="ButtonStyle.Primary" 
                          Path="/"
                          Size="ButtonSize.Small"
                          class="rz-my-2"
                          Text="BACK TO MAIN MENU" />
        </div>
    </RadzenCard>
</div>

<style>
    .leaderboard-table .rz-grid-table { /* More specific selector for RadzenDataGrid */
        font-size: 0.85rem; /* Adjust base font size for the table */
    }

    .leaderboard-table .rz-column-title,
    .leaderboard-table .rz-cell-data {
        padding: 6px 8px; /* Adjust cell padding */
    }
    
    .chart-container {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 140px;
        gap: 8px;
        background-color: var(--rz-base-200); /* Light background for chart area */
        padding: 10px;
        border-radius: var(--rz-border-radius);
    }
    
    .chart-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 40px; /* Fixed width for each bar item */
        text-align: center;
    }
    
    .chart-bar {
        width: 30px; /* Width of the actual bar */
        border-radius: var(--rz-border-radius) var(--rz-border-radius) 0 0; /* Rounded top corners */
        position: relative;
        display: flex;
        align-items: flex-start; /* Value at the top */
        justify-content: center;
        transition: height 0.3s ease-out; /* Smooth height transition */
    }
    
    .chart-value {
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding-top: 2px; /* Padding for value inside the bar */
    }
    
    .chart-label {
        font-size: 10px;
        margin-top: 4px;
        color: var(--rz-text-secondary-color); /* Radzen secondary text color */
    }
        
    @@media (max-width: 600px) {
        .leaderboard-table .rz-grid-table {
            font-size: 0.75rem;
        }
        
        .leaderboard-table .rz-column-title,
        .leaderboard-table .rz-cell-data {
            padding: 4px 3px;
        }
                
        .rz-card { /* Reduce padding on cards for mobile */
            padding: 0.5rem !important;
        }
        
        .rz-text-h5 { /* Adjust heading size for mobile */
            font-size: 1.1rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .chart-container {
            height: 100px; /* Smaller chart on mobile */
        }
        
        .chart-item {
            width: 30px;
        }
        
        .chart-bar {
            width: 20px;
        }
    }
</style>

@code {
    private bool Loading { get; set; } = true;
    private string? ErrorMessage { get; set; }
    private List<Player> Players { get; set; } = new List<Player>();
    private List<GameSession> RecentGames { get; set; } = new List<GameSession>();
    
    private int TotalGamesPlayed => Players.Sum(p => p.GamesPlayed);
    private int TotalQuestionsAsked => TotalGamesPlayed * 20;
    private int TotalCorrectAnswers => Players.Sum(p => p.TotalCorrectAnswers);
    private double OverallAccuracy => TotalQuestionsAsked > 0 ? (double)TotalCorrectAnswers / TotalQuestionsAsked : 0;
    private string AverageGameDuration => CalculateAverageGameDuration();
    
    private Dictionary<DateTime, int> GamesPlayedPerDay { get; set; } = new Dictionary<DateTime, int>();
    private Dictionary<DateTime, int> QuestionsAskedPerDay { get; set; } = new Dictionary<DateTime, int>();
    
    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initialized");
        await LoadLeaderboard();
    }
    
    private async Task LoadLeaderboard()
    {
        try
        {
            Logger.LogInformation("Starting to load leaderboard data");
            Loading = true;
            ErrorMessage = null;
            StateHasChanged();
            
            await Task.Delay(500); 
            
            Players = new List<Player>
            {
                new Player { Initials = "ACE", GamesPlayed = 10, GamesWon = 7, TotalScore = 750, TotalCorrectAnswers = 70 },
                new Player { Initials = "BOB", GamesPlayed = 12, GamesWon = 6, TotalScore = 680, TotalCorrectAnswers = 65 },
                new Player { Initials = "CAT", GamesPlayed = 8, GamesWon = 5, TotalScore = 500, TotalCorrectAnswers = 50 },
                new Player { Initials = "DAN", GamesPlayed = 15, GamesWon = 10, TotalScore = 1050, TotalCorrectAnswers = 95 },
                new Player { Initials = "ELI", GamesPlayed = 5, GamesWon = 1, TotalScore = 120, TotalCorrectAnswers = 15 }
            };
            
            RecentGames = new List<GameSession>();
            var random = new Random();
            for(int i = 0; i < 20; i++) // More game sessions for better chart data
            {
                var daysAgo = random.Next(0, 7);
                var durationMins = random.Next(3, 8);
                RecentGames.Add(new GameSession { 
                    StartTime = DateTime.UtcNow.AddDays(-daysAgo).AddHours(-random.Next(0,5)), 
                    EndTime = DateTime.UtcNow.AddDays(-daysAgo).AddHours(-random.Next(0,5)).AddMinutes(durationMins), 
                    Player1 = new Player { Initials = "P1" }, Player2 = new Player { Initials = "P2" } 
                });
            }
            
            CalculateDailyStatistics();
            
            Players = Players
                .OrderByDescending(p => p.TotalScore)
                .Select((p, index) => {
                    p.Rank = index + 1;
                    return p;
                })
                .ToList();
            
            Logger.LogInformation("Leaderboard loaded successfully with {Count} players", Players.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load leaderboard");
            ErrorMessage = $"Failed to load leaderboard: {ex.Message}";
        }
        finally
        {
            Loading = false;
            StateHasChanged();
        }
    }
    
    private void CalculateDailyStatistics()
    {
        GamesPlayedPerDay.Clear();
        QuestionsAskedPerDay.Clear();
        
        var today = DateTime.Today;
        for (int i = 6; i >= 0; i--) // Initialize last 7 days
        {
            var day = today.AddDays(-i);
            GamesPlayedPerDay[day] = 0;
            QuestionsAskedPerDay[day] = 0;
        }
        
        foreach (var game in RecentGames.Where(g => g.EndTime.HasValue))
        {
            var gameDate = game.EndTime!.Value.Date;
            if (GamesPlayedPerDay.ContainsKey(gameDate)) // Only count if within the last 7 days initialized
            {
                GamesPlayedPerDay[gameDate]++;
                QuestionsAskedPerDay[gameDate] += 20; 
            }
        }
    }
    
    private string CalculateAverageGameDuration()
    {
        if (RecentGames.Count == 0) return "0:00";
        var completedGames = RecentGames.Where(g => g.StartTime.HasValue && g.EndTime.HasValue).ToList();
        if (completedGames.Count == 0) return "0:00";
        var totalDuration = completedGames.Sum(g => (g.EndTime!.Value - g.StartTime!.Value).TotalSeconds);
        var averageSeconds = totalDuration / completedGames.Count;
        return $"{(int)(averageSeconds / 60)}:{(int)(averageSeconds % 60):00}";
    }
    
    private string FormatDayLabel(DateTime date) => date.ToString("MM/dd");
    
    private BadgeStyle GetPlayerBadgeStyle(int rank)
    {
        return rank switch {
            1 => BadgeStyle.Success, // Using Success for Gold
            2 => BadgeStyle.Info,    // Using Info for Silver
            3 => BadgeStyle.Warning, // Using Warning for Bronze
            _ => BadgeStyle.Light
        };
    }

    private string GetRankColorString(int rank)
    {
        return rank switch {
            1 => "gold", 
            2 => "silver",
            3 => "#cd7f32", // Bronze hex
            _ => "inherit"
        };
    }
}
