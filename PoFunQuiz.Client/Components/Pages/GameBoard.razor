@page "/game-board"
@using PoFunQuiz.Client;
@using PoFunQuiz.Core.Services
@using PoFunQuiz.Core.Models
@using System.Timers
@using System.Diagnostics
@inject NavigationManager Navigation
@inject PoFunQuiz.Client.GameState GameState
@inject IJSRuntime JS
@inject ILogger<GameBoard> Logger
@implements IDisposable
@rendermode InteractiveWebAssembly

<PageTitle>PoFunQuiz</PageTitle>

<!-- Import the separate CSS file for mobile styles -->
<link href="css/gameboard-mobile.css" rel="stylesheet" />

<div class="game-page">
    @if (GameState.CurrentGame == null || 
         GameState.CurrentGame.Player1Questions == null || 
         GameState.CurrentGame.Player2Questions == null)
    {
        <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
            <MudText Typo="Typo.h4" Class="mb-4">Game session not ready.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">Return to Main Menu</MudButton>
        </MudContainer>
    }
    else
    {
        <div @onkeydown="HandleKeyDown" tabindex="0" @ref="gameContainer" id="gameContainer" @onclick="FocusGameContainer" class="game-container">
            <MudContainer MaxWidth="MaxWidth.Large" Class="pa-2 mt-2">
                <!-- Game Timer and Score Info -->
                <MudGrid>
                    <MudItem xs="12">
                        <MudPaper Elevation="3" Class="d-flex justify-space-between align-center pa-2 mb-2" Style="background: linear-gradient(to right, #6a11cb, #2575fc); color: white;">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Timer" Class="mr-2" />
                                <MudText Typo="Typo.body1" Class="@(TimeRemaining <= 5 ? "timer-pulse" : "")" Color="@(TimeRemaining <= 10 ? Color.Error : Color.Default)">
                                    @TimeRemaining s
                                </MudText>
                            </div>
                            <div class="d-flex gap-4">
                                <div class="text-center">
                                    <MudText Typo="Typo.caption">P1 Streak: @GameState.CurrentGame.Player1Streak</MudText>
                                    <MudText Typo="Typo.caption">Score: @GameState.CurrentGame.Player1Score</MudText>
                                </div>
                                <div class="text-center">
                                    <MudText Typo="Typo.caption">P2 Streak: @GameState.CurrentGame.Player2Streak</MudText>
                                    <MudText Typo="Typo.caption">Score: @GameState.CurrentGame.Player2Score</MudText>
                                </div>
                            </div>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <!-- Player Boards -->
                <MudGrid>
                    <!-- Player 1 Board -->
                    <MudItem xs="12" md="6" Class="@(Player1HasFinished ? "opacity-50" : "")">
                        <MudPaper Elevation="3" Class="pa-4">
                            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                                @GameState.CurrentGame.Player1.Initials
                                @if (GameState.CurrentGame.Player1Streak >= 3)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Whatshot" Color="Color.Error" />
                                }
                            </MudText>
                            
                            @if (Player1QuestionIndex < GameState.CurrentGame.Player1Questions.Count)
                            {
                                var question = GameState.CurrentGame.Player1Questions[Player1QuestionIndex];
                                <div class="question-container">
                                    <MudText Class="mb-4">@question.Question</MudText>
                                    <div class="options-grid">
                                        @for (int i = 0; i < question.Options.Count; i++)
                                        {
                                            var index = i;
                                            <div class="option-item @GetAnswerItemClass(1, index)" 
                                                 @onclick="() => HandleTouchAnswer(1, index)">
                                                <span class="option-number">@(i + 1)</span>
                                                <span class="option-text">@question.Options[i]</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </MudPaper>
                    </MudItem>

                    <!-- Player 2 Board -->
                    <MudItem xs="12" md="6" Class="@(Player2HasFinished ? "opacity-50" : "")">
                        <MudPaper Elevation="3" Class="pa-4">
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">
                                @GameState.CurrentGame.Player2.Initials
                                @if (GameState.CurrentGame.Player2Streak >= 3)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Whatshot" Color="Color.Error" />
                                }
                            </MudText>
                            
                            @if (Player2QuestionIndex < GameState.CurrentGame.Player2Questions.Count)
                            {
                                var question = GameState.CurrentGame.Player2Questions[Player2QuestionIndex];
                                <div class="question-container">
                                    <MudText Class="mb-4">@question.Question</MudText>
                                    <div class="options-grid">
                                        @for (int i = 0; i < question.Options.Count; i++)
                                        {
                                            var index = i;
                                            <div class="option-item @GetAnswerItemClass(2, index)"
                                                 @onclick="() => HandleTouchAnswer(2, index)">
                                                <span class="option-number">@(i + 1)</span>
                                                <span class="option-text">@question.Options[i]</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        </div>
    }
</div>

<style>
    /* --- Animation Styles --- */
    @@keyframes correctAnswerFlash {
      0%, 100% { background-color: var(--mud-palette-background-grey); transform: scale(1); } /* Use a subtle background */
      50% { background-color: var(--mud-palette-success); color: white; transform: scale(1.03); } /* Flash success color */
    }

    @@keyframes incorrectAnswerShake {
      0%, 100% { background-color: var(--mud-palette-background-grey); transform: translateX(0); } /* Use a subtle background */
      10%, 30%, 50%, 70%, 90% { background-color: var(--mud-palette-error); color: white; transform: translateX(-3px); } /* Flash error color and shake */
      20%, 40%, 60%, 80% { background-color: var(--mud-palette-error); color: white; transform: translateX(3px); }
    }

    @@keyframes timerPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .correct-answer-flash {
      animation: correctAnswerFlash 0.4s ease-in-out; /* Slightly faster animation */
    }

    .incorrect-answer-shake {
      animation: incorrectAnswerShake 0.4s ease-in-out; /* Slightly faster animation */
    }

    .timer-pulse {
        animation: timerPulse 1s infinite ease-in-out;
    }

    .score-text {
        transition: color 0.3s ease, transform 0.3s ease; /* Simple transition for score */
    }
    /* --- End Animation Styles --- */

    .game-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 20px;
    }
    
    .game-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    
    .answer-list {
        margin-bottom: 10px;
        overflow-y: auto;
        max-height: 200px;
    }
    
    .selected-option {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .score-container {
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 4px;
        padding: 2px 8px;
        min-width: 30px;
        text-align: center;
        margin-right: 4px;
    }
    
    /* Optimized question container */
    .compact-question {
        min-height: unset !important;
        max-height: 80px !important;
    }
    
    .question-text {
        line-height: 1.3 !important;
        margin: 0 !important;
    }

    .game-container {
        outline: none;
    }

    .question-container {
        min-height: 200px;
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .option-item {
        position: relative;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        min-height: 60px;
    }

    .option-item:hover {
        background-color: #f5f5f5;
        transform: translateY(-2px);
    }

    .option-item.selected {
        background-color: #e3f2fd;
        border-color: #2196f3;
    }

    .option-item.correct {
        background-color: #c8e6c9;
        border-color: #4caf50;
    }

    .option-item.incorrect {
        background-color: #ffcdd2;
        border-color: #f44336;
    }

    .option-number {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        font-size: 0.8rem;
        color: #666;
    }

    .option-text {
        margin-left: 1.5rem;
        flex: 1;
    }

    @@media (max-width: 600px) {
        .options-grid {
            grid-template-columns: 1fr;
        }

        .option-item {
            min-height: 50px;
            padding: 0.75rem;
        }
    }
</style>

@code {
    private ElementReference gameContainer;
    private Timer? gameTimer;
    private Timer? feedbackTimer;
    private Timer? reconnectTimer;
    private int TimeRemaining { get; set; } = 60;
    private bool isInitialized = false;
    private Stopwatch answerStopwatch = new();
    
    // Player 1 state
    private int Player1QuestionIndex { get; set; } = 0;
    private bool Player1HasFinished { get; set; } = false;
    private bool Player1FeedbackVisible { get; set; } = false;
    private bool Player1LastAnswerCorrect { get; set; } = false;
    private List<int> Player1Selections { get; set; } = new List<int>();
    private int? Player1JustSelectedAnswerIndex { get; set; } = null;
    
    // Player 2 state
    private int Player2QuestionIndex { get; set; } = 0;
    private bool Player2HasFinished { get; set; } = false;
    private bool Player2FeedbackVisible { get; set; } = false;
    private bool Player2LastAnswerCorrect { get; set; } = false;
    private List<int> Player2Selections { get; set; } = new List<int>();
    private int? Player2JustSelectedAnswerIndex { get; set; } = null;

    private DotNetObjectReference<GameBoard>? objRef;
    private bool isMobileDevice = false;

    protected override void OnInitialized()
    {
        try
        {
            Logger.LogInformation("üîµ GameBoard OnInitialized called at {Time}", DateTime.Now);
            Console.WriteLine($"üîµ GameBoard OnInitialized called at {DateTime.Now}");
            
            base.OnInitialized();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in OnInitialized: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in OnInitialized: {ex.Message}");
        }
    }
    
    private async Task FocusGameContainer()
    {
        try
        {
            await JS.InvokeVoidAsync("focusGameContainer", "gameContainer");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error focusing game container");
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Logger.LogInformation("üîµ GameBoard first render at {Time}", DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss"));
                Console.WriteLine($"üîµ GameBoard first render at {DateTime.Now}");
                
                if (GameState.CurrentGame == null)
                {
                    Logger.LogWarning("‚ö†Ô∏è GameState.CurrentGame is null, navigating to home");
                    Console.WriteLine("‚ö†Ô∏è GameState.CurrentGame is null, navigating to home");
                    Navigation.NavigateTo("/");
                    return;
                }
                
                // Set focus to the container to enable keyboard events
                await JS.InvokeVoidAsync("focusElement", gameContainer);
                
                // Check if we're on a mobile device
                isMobileDevice = await JS.InvokeAsync<bool>("isMobileDevice");
                Logger.LogInformation("Game board initialized. Mobile device: {IsMobile}", isMobileDevice);
                
                if (isMobileDevice)
                {
                    // Add touch support for mobile devices
                    objRef = DotNetObjectReference.Create(this);
                    await JS.InvokeVoidAsync("addTouchSupport", "gameContainer", objRef);
                }
                
                // Start the game timer
                StartGameTimer();
                
                isInitialized = true;
                Logger.LogInformation("‚úÖ GameBoard initialization complete");
                Console.WriteLine("‚úÖ GameBoard initialization complete");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "‚ùå Error during GameBoard first render: {Message}", ex.Message);
                Console.WriteLine($"‚ùå Error during GameBoard first render: {ex.Message}");
            }
        }
        else
        {
            try
            {
                // Add touch feedback after each render to ensure new options get the handlers
                await JS.InvokeVoidAsync("addTouchFeedback");
            }
            catch (Exception ex)
            {
                // Log the error but don't crash the component
                Logger.LogWarning(ex, "‚ö†Ô∏è Error adding touch feedback: {Message}", ex.Message);
                Console.WriteLine($"‚ö†Ô∏è Error adding touch feedback: {ex.Message}");
            }
        }
    }

    private void StartGameTimer()
    {
        try
        {
            Logger.LogInformation("‚è±Ô∏è StartGameTimer called at {Time}", DateTime.Now);
            Console.WriteLine($"‚è±Ô∏è StartGameTimer called at {DateTime.Now}");
            
            gameTimer?.Stop();
            gameTimer?.Dispose();
            
            gameTimer = new Timer(1000);
            gameTimer.Elapsed += OnGameTimerElapsed;
            gameTimer.AutoReset = true;
            gameTimer.Enabled = true;
            
            Logger.LogInformation("‚úÖ Game timer successfully started");
            Console.WriteLine("‚úÖ Game timer successfully started");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error starting game timer: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error starting game timer: {ex.Message}");
        }
    }
    
    private void OnGameTimerElapsed(object? sender, ElapsedEventArgs e) // Made sender nullable
    {
        try
        {
            InvokeAsync(() => 
            {
                TimeRemaining--;
                
                if (TimeRemaining % 5 == 0 || TimeRemaining <= 10)
                {
                    Logger.LogInformation("‚è±Ô∏è Timer update: {TimeRemaining} seconds remaining at {Time}", 
                        TimeRemaining, DateTime.Now);
                    Console.WriteLine($"‚è±Ô∏è Timer update: {TimeRemaining} seconds remaining at {DateTime.Now}");
                }
                
                if (TimeRemaining <= 0)
                {
                    Logger.LogInformation("‚è±Ô∏è Timer reached zero, ending game");
                    Console.WriteLine("‚è±Ô∏è Timer reached zero, ending game");
                    EndGame();
                }
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in timer callback: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in timer callback: {ex.Message}");
        }
    }


    private string GetAnswerItemClass(int playerNumber, int optionIndex)
    {
        var selections = playerNumber == 1 ? Player1Selections : Player2Selections;
        var feedbackVisible = playerNumber == 1 ? Player1FeedbackVisible : Player2FeedbackVisible;
        var lastAnswerCorrect = playerNumber == 1 ? Player1LastAnswerCorrect : Player2LastAnswerCorrect;
        var justSelected = playerNumber == 1 ? Player1JustSelectedAnswerIndex : Player2JustSelectedAnswerIndex;
        
        if (!selections.Contains(optionIndex))
            return "";
            
        if (!feedbackVisible)
            return "selected";
            
        if (justSelected == optionIndex)
            return lastAnswerCorrect ? "correct" : "incorrect";
            
        return "selected";
    }
    
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        try
        {
            // Handle Player 1 inputs (keys 1-4)
            if (!Player1HasFinished && (e.Key == "1" || e.Key == "2" || e.Key == "3" || e.Key == "4"))
            {
                int index = int.Parse(e.Key) - 1;
                HandlePlayerAnswer(1, index);
            }
            
            // Handle Player 2 inputs (keys 6-9)
            if (!Player2HasFinished && (e.Key == "6" || e.Key == "7" || e.Key == "8" || e.Key == "9"))
            {
                int index = int.Parse(e.Key) - 6;
                HandlePlayerAnswer(2, index);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling keyboard input");
        }
    }
    
    private void HandleTouchAnswer(int playerNumber, int selectedOptionIndex)
    {
        if ((playerNumber == 1 && !Player1HasFinished) || 
            (playerNumber == 2 && !Player2HasFinished))
        {
            HandlePlayerAnswer(playerNumber, selectedOptionIndex);
        }
    }
    
    private void HandlePlayerAnswer(int playerNumber, int selectedOptionIndex)
    {
        try
        {
            if (GameState.CurrentGame?.Player1Questions == null || GameState.CurrentGame?.Player2Questions == null)
                return;

            var elapsedSeconds = answerStopwatch.Elapsed.TotalSeconds;
            var speedMultiplier = CalculateSpeedMultiplier(elapsedSeconds);
            
            if (playerNumber == 1 && !Player1HasFinished && Player1QuestionIndex < GameState.CurrentGame.Player1Questions.Count)
            {
                var currentQuestion = GameState.CurrentGame.Player1Questions[Player1QuestionIndex];
                bool isCorrect = selectedOptionIndex == currentQuestion.CorrectOptionIndex;
                
                Player1LastAnswerCorrect = isCorrect;
                Player1FeedbackVisible = true;
                Player1Selections.Add(selectedOptionIndex);
                Player1JustSelectedAnswerIndex = selectedOptionIndex;

                GameState.CurrentGame.AddAnswer(1, isCorrect, currentQuestion.BasePoints, speedMultiplier);
                
                ShowFeedbackThenAdvance(playerNumber);
            }
            else if (playerNumber == 2 && !Player2HasFinished && Player2QuestionIndex < GameState.CurrentGame.Player2Questions.Count)
            {
                var currentQuestion = GameState.CurrentGame.Player2Questions[Player2QuestionIndex];
                bool isCorrect = selectedOptionIndex == currentQuestion.CorrectOptionIndex;
                
                Player2LastAnswerCorrect = isCorrect;
                Player2FeedbackVisible = true;
                Player2Selections.Add(selectedOptionIndex);
                Player2JustSelectedAnswerIndex = selectedOptionIndex;

                GameState.CurrentGame.AddAnswer(2, isCorrect, currentQuestion.BasePoints, speedMultiplier);
                
                ShowFeedbackThenAdvance(playerNumber);
            }

            // Reset stopwatch for next answer
            answerStopwatch.Restart();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling player answer");
        }
    }
    
    private double CalculateSpeedMultiplier(double elapsedSeconds)
    {
        return elapsedSeconds switch
        {
            <= 2.0 => 2.0,  // Super fast - 2x points
            <= 4.0 => 1.5,  // Fast - 1.5x points
            <= 6.0 => 1.25, // Quick - 1.25x points
            _ => 1.0        // Normal speed - no bonus
        };
    }
    
    private void ShowFeedbackThenAdvance(int playerNumber)
    {
        feedbackTimer?.Dispose();
        feedbackTimer = new Timer(1000);
        feedbackTimer.Elapsed += (_, _) =>
        {
            InvokeAsync(() =>
            {
                if (playerNumber == 1)
                {
                    Player1FeedbackVisible = false;
                    Player1Selections.Clear();
                    Player1JustSelectedAnswerIndex = null;
                    Player1QuestionIndex++;
                    
                    if (Player1QuestionIndex >= GameState.CurrentGame!.Player1Questions.Count)
                    {
                        Player1HasFinished = true;
                        CalculateTimeBonus(playerNumber);
                    }
                }
                else
                {
                    Player2FeedbackVisible = false;
                    Player2Selections.Clear();
                    Player2JustSelectedAnswerIndex = null;
                    Player2QuestionIndex++;
                    
                    if (Player2QuestionIndex >= GameState.CurrentGame!.Player2Questions.Count)
                    {
                        Player2HasFinished = true;
                        CalculateTimeBonus(playerNumber);
                    }
                }
                
                if (Player1HasFinished && Player2HasFinished)
                {
                    EndGame();
                    Navigation.NavigateTo("/results");
                }
                else
                {
                    StateHasChanged();
                }
            });
        };
        
        feedbackTimer.AutoReset = false;
        feedbackTimer.Enabled = true;
    }
    
    private void CalculateTimeBonus(int playerNumber)
    {
        int bonus = Math.Min(3, (int)Math.Ceiling(TimeRemaining / 20.0));
        
        if (playerNumber == 1)
            GameState.CurrentGame!.Player1TimeBonus = bonus;
        else
            GameState.CurrentGame!.Player2TimeBonus = bonus;
    }
    
    private void EndGame()
    {
        gameTimer?.Stop();
        feedbackTimer?.Stop();

        if (GameState.CurrentGame == null)
            return;
            
        GameState.CurrentGame.EndTime = DateTime.UtcNow;
        
        // _ = GameSessionService.SaveGameResultsAsync(GameState.CurrentGame); // Removed server-side call
    }
    
    [JSInvokable]
    public void HandleSwipe(string direction)
    {
        Logger.LogInformation("Swipe detected: {Direction}", direction);
        // Handle swipe actions if needed
    }
    
    public void Dispose()
    {
        try
        {
            Logger.LogInformation("‚ôªÔ∏è Disposing GameBoard component at {Time}", DateTime.Now);
            Console.WriteLine($"‚ôªÔ∏è Disposing GameBoard component at {DateTime.Now}");
            
            gameTimer?.Stop();
            gameTimer?.Dispose();
            feedbackTimer?.Stop();
            feedbackTimer?.Dispose();
            
            // Dispose of the .NET object reference
            objRef?.Dispose();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in Dispose: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in Dispose: {ex.Message}");
        }
    }
}
