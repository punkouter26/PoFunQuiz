@page "/"
@using PoFunQuiz.Core.Services
@using PoFunQuiz.Core.Models
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using Radzen.Blazor
@inject NavigationManager Navigation
@inject PoFunQuiz.Client.GameState GameState
@inject IWebAssemblyHostEnvironment HostEnvironment
@rendermode InteractiveWebAssembly

<PageTitle>PoFunQuiz - Welcome</PageTitle>

<div class="rz-display-flex rz-flex-column rz-align-items-center rz-justify-content-center" style="min-height: 85vh; padding: 1rem;">
    <RadzenText TextStyle="TextStyle.H3" class="rz-mb-4 rz-text-align-center rz-text-primary">Welcome to PoFunQuiz</RadzenText>

    <RadzenCard class="rz-p-3" style="width: 100%; max-width: 450px;">
        <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Enter Player Initials</RadzenText>

        <RadzenStack Gap="3" class="rz-mb-3">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="3">
                <RadzenIcon Icon="person" class="rz-text-primary" />
                <RadzenTextBox @bind-Value="@Player1Initials"
                               Placeholder="Player 1 Initials"
                               MaxLength="3"
                               Name="Player1Initials"
                               Style="text-transform: uppercase; flex-grow: 1;"
                               Change="@(args => OnTextChanged(args, 1))" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="3">
                <RadzenIcon Icon="person" class="rz-text-secondary" />
                <RadzenTextBox @bind-Value="@Player2Initials"
                               Placeholder="Player 2 Initials"
                               MaxLength="3"
                               Name="Player2Initials"
                               Style="text-transform: uppercase; flex-grow: 1;"
                               Change="@(args => OnTextChanged(args, 2))" />
            </RadzenStack>
        </RadzenStack>

        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-3 d-none d-sm-block">
            Enter 3-letter initials for each player to begin. Players will share the same screen during the quiz.
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2 d-block d-sm-none">
            Enter 3-letter initials for each player.
        </RadzenText>

        @if (!string.IsNullOrEmpty(ValidationSummary))
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Radzen.Variant.Flat" Shade="Shade.Lighter" AllowClose="false" class="mt-2 mb-2">
                @((MarkupString)ValidationSummary)
            </RadzenAlert>
        }

        <RadzenText TextStyle="TextStyle.Caption" class="mt-2" TextColor="@(IsFormValid ? "rz-text-success" : "")">
            P1: "@Player1Initials" (Length: @(Player1Initials?.Length ?? 0)), P2: "@Player2Initials" (Length: @(Player2Initials?.Length ?? 0))
        </RadzenText>
        
        <RadzenStack Gap="2" class="rz-mt-4">
            <RadzenButton ButtonStyle="ButtonStyle.Primary"
                          style="width: 100%;"
                          Disabled="@(!IsFormValid)"
                          Click="StartGame"
                          Text="START GAME" />

            <RadzenButton ButtonStyle="ButtonStyle.Light"
                          Shade="Shade.Lighter"
                          style="width: 100%;"
                          Path="/leaderboard"
                          Text="LEADERBOARD" />
        </RadzenStack>
    </RadzenCard>

    <RadzenCard class="mt-4 pa-3 d-none d-sm-block" style="width: 100%; max-width: 450px; background-color: var(--rz-base-200);">
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Player Controls:</RadzenText>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Gap="2">
            <RadzenText TextStyle="TextStyle.Body2"><b>Player 1:</b> Use keys 1-4 to select answers</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2"><b>Player 2:</b> Use keys 6-9 to select answers</RadzenText>
        </RadzenStack>
    </RadzenCard>

    <RadzenCard class="mt-2 pa-2 d-block d-sm-none" style="width: 100%; max-width: 450px; background-color: var(--rz-base-200);">
        <RadzenStack Gap="1">
            <RadzenText TextStyle="TextStyle.Caption"><b>P1:</b> Keys 1-4</RadzenText>
            <RadzenText TextStyle="TextStyle.Caption"><b>P2:</b> Keys 6-9</RadzenText>
        </RadzenStack>
    </RadzenCard>
</div>

<style>
    @@media (max-width: 600px) {
        .rz-text-h3 { /* Example for RadzenText H3 */
            font-size: 1.5rem !important;
        }
        
        .rz-text-h5 { /* Example for RadzenText H5 */
            font-size: 1.1rem !important;
        }
        
        /* Adjust container padding for mobile if needed */
        .rz-display-flex.rz-flex-column.rz-align-items-center.rz-justify-content-center {
            padding: 0.5rem !important;
            min-height: 100vh !important;
        }
        
        .rz-card { /* Ensure card doesn't have excessive top margin on mobile */
            margin-top: 0 !important;
        }
    }
</style>

@code {
    private string Player1Initials { get; set; } = "ABC";
    private string Player2Initials { get; set; } = "XYZ";
    private string ValidationSummary { get; set; } = "";

    private bool IsFormValid =>
        !string.IsNullOrWhiteSpace(Player1Initials) &&
        !string.IsNullOrWhiteSpace(Player2Initials) &&
        Player1Initials.Length == 3 &&
        Player2Initials.Length == 3 &&
        Player1Initials.ToUpperInvariant() != Player2Initials.ToUpperInvariant();

    private void ValidateForm()
    {
        var errors = new List<string>();
        if (string.IsNullOrWhiteSpace(Player1Initials))
        {
            errors.Add("Player 1 initials required.");
        }
        else if (Player1Initials.Length != 3)
        {
            errors.Add("Player 1 initials must be 3 characters.");
        }

        if (string.IsNullOrWhiteSpace(Player2Initials))
        {
            errors.Add("Player 2 initials required.");
        }
        else if (Player2Initials.Length != 3)
        {
            errors.Add("Player 2 initials must be 3 characters.");
        }

        if (!string.IsNullOrWhiteSpace(Player1Initials) && Player1Initials.Length == 3 &&
            !string.IsNullOrWhiteSpace(Player2Initials) && Player2Initials.Length == 3 &&
            Player1Initials.ToUpperInvariant() == Player2Initials.ToUpperInvariant())
        {
            errors.Add("Players cannot have the same initials.");
        }
        ValidationSummary = string.Join("<br/>", errors);
        StateHasChanged();
    }
    
    private void OnTextChanged(object value, int playerNumber)
    {
        string? sValue = value?.ToString();
        if (sValue == null) return;

        string upperValue = sValue.ToUpperInvariant();

        if (playerNumber == 1)
            Player1Initials = upperValue;
        else
            Player2Initials = upperValue;
        
        ValidateForm();
    }

    private void StartGame()
    {
        ValidateForm();
        if (!IsFormValid)
            return;

        try
        {
            GameState.CurrentGame = new GameSession
            {
                Player1 = new Player { Initials = Player1Initials.ToUpperInvariant() },
                Player2 = new Player { Initials = Player2Initials.ToUpperInvariant() },
                StartTime = DateTime.UtcNow,
                GameId = Guid.NewGuid().ToString()
            };

            var random = new Random();
            var difficultyRoll = random.Next(1, 101);
            GameState.CurrentGame.GameDifficulty = difficultyRoll switch
            {
                <= 20 => QuestionDifficulty.Easy,
                <= 80 => QuestionDifficulty.Medium,
                _ => QuestionDifficulty.Hard
            };

            var allCategories = QuestionCategories.All.ToList();
            var numCategories = random.Next(2, 4);
            var shuffledCategories = allCategories.OrderBy(_ => random.Next()).ToList();
            GameState.CurrentGame.SelectedCategories = shuffledCategories.Take(numCategories).ToList();

            Navigation.NavigateTo("/game-setup");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting game: {ex.Message}");
            ValidationSummary = $"Error starting game: {ex.Message}"; // Show error to user
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        // Only auto-start if no game is currently active
        if (GameState.CurrentGame == null)
        {
            StartGame();
            StateHasChanged();
        }
    }
}
