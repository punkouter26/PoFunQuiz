name: Deploy PoFunQuiz to Azure App Service

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: pofunquiz-web
  RESOURCE_GROUP: PoFunQuiz

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 10.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
      
    - name: Restore dependencies
      run: dotnet restore PoFunQuiz.sln
      
    - name: Build
      run: dotnet build PoFunQuiz.sln --no-restore --configuration Release
      
    - name: Test
      run: dotnet test PoFunQuiz.sln --no-build --configuration Release --verbosity normal --filter "Category!=E2E"
      continue-on-error: true
      
    - name: Publish
      run: dotnet publish src/PoFunQuiz.Web/PoFunQuiz.Web.csproj --configuration Release --output ./publish

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Deploy to Azure App Service (Run-From-Package)
      run: |
        # Build zip
        cd ./publish
        zip -r ../app.zip .
        cd ..
        # Upload to blob storage
        STORAGE_ACCOUNT="stpofunquiz26"
        CONTAINER="deployments"
        BLOB_NAME="app-$(date +%Y%m%d%H%M%S).zip"
        STORAGE_KEY=$(az storage account keys list --account-name $STORAGE_ACCOUNT --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].value" -o tsv)
        az storage blob upload \
          --account-name $STORAGE_ACCOUNT \
          --container-name $CONTAINER \
          --name $BLOB_NAME \
          --file app.zip \
          --account-key $STORAGE_KEY
        # Generate SAS URL valid for 1 year
        EXPIRY=$(date -u -d "+1 year" '+%Y-%m-%dT%H:%M:%SZ')
        SAS=$(az storage blob generate-sas \
          --account-name $STORAGE_ACCOUNT \
          --container-name $CONTAINER \
          --name $BLOB_NAME \
          --permissions r \
          --expiry $EXPIRY \
          --account-key $STORAGE_KEY \
          --https-only -o tsv)
        BLOB_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/${CONTAINER}/${BLOB_NAME}?${SAS}"
        # Set WEBSITE_RUN_FROM_PACKAGE to blob URL and restart
        az webapp config appsettings set \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings "WEBSITE_RUN_FROM_PACKAGE=${BLOB_URL}"
        az webapp restart \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }}

    - name: Health check gate
      run: |
        echo "Waiting for deployment to stabilize..."
        sleep 15
        for i in $(seq 1 6); do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.APP_NAME }}.azurewebsites.net/health)
          echo "Attempt $i/6 - /health returned $STATUS"
          if [ "$STATUS" = "200" ]; then
            BODY=$(curl -s https://${{ env.APP_NAME }}.azurewebsites.net/health)
            echo "$BODY"
            echo "Deployment health check passed"
            exit 0
          fi
          sleep 10
        done
        echo "Health check failed after 75 seconds"
        exit 1
