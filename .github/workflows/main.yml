name: Deploy PoFunQuiz to Azure

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
      
    - name: Restore dependencies
      run: dotnet restore PoFunQuiz.sln
      
    - name: Build
      run: dotnet build PoFunQuiz.sln --no-restore --configuration Release
      
    - name: Test
      run: dotnet test PoFunQuiz.sln --no-build --configuration Release --verbosity normal --filter "Category!=E2E"
      continue-on-error: true
      
    - name: Publish application
      run: dotnet publish src/PoFunQuiz.Api/PoFunQuiz.Api.csproj --configuration Release --output ./publish
      
    - name: Optimize deployment size
      run: |
        # Remove unused Radzen CSS themes (keep only standard-base.css)
        # Check if directory exists first to avoid errors
        if [ -d "./publish/wwwroot/_content/Radzen.Blazor/css" ]; then
          find ./publish/wwwroot/_content/Radzen.Blazor/css -type f ! -name 'standard-base.css*' -delete
        fi
        
        # Display optimization results
        echo "✅ Deployment optimized"
      
    - name: Create deployment package
      run: |
        cd publish
        zip -r ../deploy.zip .
        cd ..
      
    - name: Azure Login (Federated Credentials)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
    - name: Deploy to Azure App Service
      run: |
        az webapp deployment source config-zip \
          --resource-group PoFunQuiz \
          --name PoFunQuiz \
          --src deploy.zip \
          --timeout 1800
        
        echo "✅ Deployment completed successfully"
