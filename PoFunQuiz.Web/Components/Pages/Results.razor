@page "/results"
@using PoFunQuiz.Core.Services
@inject NavigationManager Navigation
@inject IPlayerStorageService PlayerService
@inject GameState GameState

<PageTitle>PoFunQuiz</PageTitle>

@if (GameState.CurrentGame == null)
{
    <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
        <MudText Typo="Typo.h4" Class="mb-4">No game results available.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">Return to Main Menu</MudButton>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
        <MudPaper Elevation="3" Class="pa-4 pa-sm-6">
            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Game Results</MudText>
            
            @if (WinnerDeclared)
            {
                <MudAlert Severity="Severity.Success" Class="my-3" Variant="Variant.Filled">
                    <MudText Typo="Typo.h6">
                        @if (IsTie)
                        {
                            <span>It's a Tie!</span>
                        }
                        else
                        {
                            <span>Winner: Player @WinnerNumber (@(Winner?.Initials ?? "???")) - Congratulations!</span>
                        }
                    </MudText>
                </MudAlert>
            }
            
            <MudGrid Class="mt-3">
                <!-- Player 1 Results -->
                <MudItem xs="12" md="6">
                    <MudCard Class="pa-2 pa-sm-4" Style="height: 100%;">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Class="mr-2" Size="Size.Small">
                                        @(GameState.CurrentGame?.Player1?.Initials ?? "P1")
                                    </MudAvatar>
                                    <MudText Typo="Typo.h6">Player 1</MudText>
                                </div>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudList T="string" Dense="true">
                                <MudListItem T="string" Icon="@Icons.Material.Filled.QuestionAnswer">
                                    <MudText Typo="Typo.body2">Questions: @GetQuestionsAnswered(1) of 10</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Check">
                                    <MudText Typo="Typo.body2">Correct: @GetCorrectAnswers(1)</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Close">
                                    <MudText Typo="Typo.body2">Incorrect: @(GetQuestionsAnswered(1) - GetCorrectAnswers(1))</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Timer">
                                    <MudText Typo="Typo.body2">Time Bonus: +@GetTimeBonus(1) points</MudText>
                                </MudListItem>
                                <MudDivider Class="my-2" />
                                <MudListItem T="string">
                                    <MudText Typo="Typo.h6">Total Score: @(GameState.CurrentGame?.Player1Score ?? 0) points</MudText>
                                </MudListItem>
                            </MudList>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                
                <!-- Player 2 Results -->
                <MudItem xs="12" md="6">
                    <MudCard Class="pa-2 pa-sm-4" Style="height: 100%;">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Secondary" Class="mr-2" Size="Size.Small">
                                        @(GameState.CurrentGame?.Player2?.Initials ?? "P2")
                                    </MudAvatar>
                                    <MudText Typo="Typo.h6">Player 2</MudText>
                                </div>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudList T="string" Dense="true">
                                <MudListItem T="string" Icon="@Icons.Material.Filled.QuestionAnswer">
                                    <MudText Typo="Typo.body2">Questions: @GetQuestionsAnswered(2) of 10</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Check">
                                    <MudText Typo="Typo.body2">Correct: @GetCorrectAnswers(2)</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Close">
                                    <MudText Typo="Typo.body2">Incorrect: @(GetQuestionsAnswered(2) - GetCorrectAnswers(2))</MudText>
                                </MudListItem>
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Timer">
                                    <MudText Typo="Typo.body2">Time Bonus: +@GetTimeBonus(2) points</MudText>
                                </MudListItem>
                                <MudDivider Class="my-2" />
                                <MudListItem T="string">
                                    <MudText Typo="Typo.h6">Total Score: @(GameState.CurrentGame?.Player2Score ?? 0) points</MudText>
                                </MudListItem>
                            </MudList>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                
                <!-- Game Statistics -->
                <MudItem xs="12">
                    <MudPaper Class="pa-2 pa-sm-4 mt-3" Elevation="0" Outlined>
                        <MudText Typo="Typo.subtitle2">Game Statistics</MudText>
                        <MudGrid>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.caption">Game Duration: @GetGameDuration()</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.caption">Total Questions: 20</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.caption">Total Correct: @(GetCorrectAnswers(1) + GetCorrectAnswers(2))</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.caption">Game ID: @(GameState.CurrentGame?.GameId?.Substring(0, 8) ?? "N/A")</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <div class="d-flex flex-column flex-sm-row justify-center mt-4">
                <MudButton Variant="Variant.Filled" 
                        Color="Color.Primary" 
                        Class="mx-1 mb-2 mb-sm-0"
                        Size="Size.Small"
                        OnClick="@PlayAgain">
                    PLAY AGAIN
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                        Color="Color.Primary" 
                        Class="mx-1 mb-2 mb-sm-0"
                        Size="Size.Small"
                        Href="/leaderboard">
                    VIEW LEADERBOARD
                </MudButton>
                <MudButton Variant="Variant.Text" 
                        Color="Color.Primary" 
                        Class="mx-1"
                        Size="Size.Small"
                        Href="/">
                    MAIN MENU
                </MudButton>
            </div>
        </MudPaper>
    </MudContainer>
}

@code {
    // Added null checks for safety, although the top-level check should prevent null CurrentGame here
    private bool WinnerDeclared => GameState.CurrentGame?.Player1Score != null && GameState.CurrentGame?.Player2Score != null;
    private bool IsTie => WinnerDeclared && GameState.CurrentGame?.Player1Score == GameState.CurrentGame?.Player2Score;
    private int WinnerNumber => (!WinnerDeclared || IsTie) ? 0 : (GameState.CurrentGame?.Player1Score > GameState.CurrentGame?.Player2Score ? 1 : 2);
    private Core.Models.Player? Winner => WinnerNumber == 1 ? GameState.CurrentGame?.Player1 : (WinnerNumber == 2 ? GameState.CurrentGame?.Player2 : null); // Made nullable
    
    protected override async Task OnInitializedAsync() // Changed to async Task
    {
        // Redirect to home if no game session exists
        if (GameState.CurrentGame == null)
        {
            Navigation.NavigateTo("/");
            return;
        }
        
        // Update player statistics in the background
        await UpdatePlayerStatisticsAsync(); // Added await
    }
    
    private int GetCorrectAnswers(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0; // Null check

        // In a real implementation, this would come from the game session tracking
        // For now we'll use a simplified calculation
        var baseScore = playerNumber == 1 
            ? GameState.CurrentGame.Player1Score - GetTimeBonus(1) // Removed ?? 0
            : GameState.CurrentGame.Player2Score - GetTimeBonus(2); // Removed ?? 0
        
        return Math.Max(0, baseScore); 
    }
    
    private int GetTimeBonus(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0; // Null check

        // In a real implementation, this would be stored explicitly in the game session
        // For simplicity, we'll assume a maximum of 3 points time bonus
        var totalScore = playerNumber == 1 
            ? GameState.CurrentGame.Player1Score // Removed ?? 0
            : GameState.CurrentGame.Player2Score; // Removed ?? 0
        
        var correctAnswers = GetQuestionsAnswered(playerNumber); // This already returns 0 if CurrentGame is null
        
        return Math.Min(3, Math.Max(0, totalScore - correctAnswers)); // totalScore is already int
    }
    
    private int GetQuestionsAnswered(int playerNumber)
    {
        if (GameState.CurrentGame == null) return 0; // Null check

        // In a real implementation, this would come from the game session tracking
        // For now we'll assume all 10 questions were answered if game exists
        return 10; 
    }
    
    private string GetGameDuration()
    {
        // Add null check for CurrentGame
        if (GameState.CurrentGame?.StartTime.HasValue == true && GameState.CurrentGame?.EndTime.HasValue == true)
        {
            var duration = GameState.CurrentGame.EndTime.Value - GameState.CurrentGame.StartTime.Value;
            return $"{duration.Minutes:D2}:{duration.Seconds:D2}";
        }
        
        return "00:00";
    }
    
    private void PlayAgain()
    {
        // Add null check
        if (GameState.CurrentGame?.Player1 == null || GameState.CurrentGame?.Player2 == null)
        {
            // Should not happen if we are on the results page, but good practice
            Navigation.NavigateTo("/"); 
            return;
        }

        // Reset game state but keep the same players
        var player1 = GameState.CurrentGame.Player1;
        var player2 = GameState.CurrentGame.Player2;
        
        // Create a new game session with the same players
        GameState.CurrentGame = new Core.Models.GameSession
        {
            Player1 = player1,
            Player2 = player2,
            StartTime = DateTime.UtcNow,
            GameId = Guid.NewGuid().ToString()
        };
        
        // Navigate to game setup
        Navigation.NavigateTo("/game-setup");
    }
    
    private async Task UpdatePlayerStatisticsAsync()
    {
        // Add null check
        if (GameState.CurrentGame?.Player1 == null || GameState.CurrentGame?.Player2 == null)
        {
             Console.WriteLine($"Error updating player statistics: CurrentGame or Players are null.");
             return; // Cannot update stats if game or players are missing
        }

        try
        {
            // Determine winner status safely
            bool player1IsWinner = WinnerNumber == 1;
            bool player2IsWinner = WinnerNumber == 2;

            // Get scores safely (scores are int, not int?)
            int player1Score = GameState.CurrentGame.Player1Score; // Removed ?? 0
            int player2Score = GameState.CurrentGame.Player2Score; // Removed ?? 0

            // Update player 1 stats
            await UpdatePlayerStats(GameState.CurrentGame.Player1, 
                                   player1IsWinner, 
                                   GetCorrectAnswers(1),
                                   player1Score);
            
            // Update player 2 stats
            await UpdatePlayerStats(GameState.CurrentGame.Player2, 
                                   player2IsWinner,
                                   GetCorrectAnswers(2),
                                   player2Score);
        }
        catch (Exception ex)
        {
            // In a real app, we would log this error
            Console.WriteLine($"Error updating player statistics: {ex.Message}");
        }
    }
    
    private async Task UpdatePlayerStats(Core.Models.Player? player, bool isWinner, int correctAnswers, int totalScore) // Made player nullable
    {
        if (player == null) return; // Add null check for player

        // Update player stats
        player.GamesPlayed++;
        if (isWinner) player.GamesWon++;
        player.TotalScore += totalScore;
        player.TotalCorrectAnswers += correctAnswers;
        
        // Save updated player stats to storage
        await PlayerService.UpdatePlayerAsync(player);
    }
}

<style>
    @@media (max-width: 600px) {
        .mud-container {
            padding: 0.5rem !important;
        }
        
        .mud-card-content {
            padding: 8px !important;
        }
        
        .mud-card-header {
            padding: 8px !important;
        }
        
        .mud-list-item {
            padding-top: 4px !important;
            padding-bottom: 4px !important;
        }
    }
</style>
