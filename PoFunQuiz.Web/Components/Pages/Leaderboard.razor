@page "/leaderboard"
@using PoFunQuiz.Core.Models
@using PoFunQuiz.Core.Services
@using Microsoft.Extensions.Logging
@using Azure.Data.Tables
@using System.Text.Json
@using Microsoft.Extensions.Hosting
@inject NavigationManager Navigation
@inject IPlayerStorageService PlayerService
@inject ILogger<Leaderboard> Logger
@inject IHostEnvironment HostEnvironment

<PageTitle>PoFunQuiz - Leaderboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-2 px-1 px-sm-4">
    <MudPaper Elevation="3" Class="pa-2 pa-sm-4">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">Leaderboard</MudText>
        
        @if (Loading)
        {
            <div class="d-flex justify-center my-2">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            </div>
        }
        else if (ErrorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Class="my-2">@ErrorMessage</MudAlert>
            <div class="d-flex flex-column align-center">
                <MudButton Variant="Variant.Filled" 
                         Color="Color.Primary"
                         OnClick="LoadLeaderboard"
                         Class="my-2">
                    RETRY
                </MudButton>
            </div>
        }
        else if (Players.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="my-2">
                No player data available yet. Play some games to populate the leaderboard!
            </MudAlert>
        }
        else
        {
            <MudText Typo="Typo.subtitle1" Class="mb-2">Top Players</MudText>
            
            <div class="table-responsive">
                <MudTable Items="@Players" 
                         Dense="true" 
                         Hover="true" 
                         Bordered="false" 
                         Striped="true"
                         FixedHeader="true"
                         Class="leaderboard-table">
                    <HeaderContent>
                        <MudTh Style="min-width: 50px;">Rank</MudTh>
                        <MudTh Style="min-width: 70px;">Player</MudTh>
                        <MudTh Style="min-width: 60px;">Games</MudTh>
                        <MudTh Style="min-width: 50px;">Wins</MudTh>
                        <MudTh Style="min-width: 60px;">Score</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            @if (context.Rank <= 3)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" 
                                        Color="@(context.Rank == 1 ? Color.Warning : context.Rank == 2 ? Color.Tertiary : Color.Tertiary)" 
                                        Size="Size.Small" />
                            }
                            @context.Rank
                        </MudTd>
                        <MudTd>
                            <MudChip T="string" Color="@GetPlayerColor(context.Rank)" Size="Size.Small">@context.Initials</MudChip>
                        </MudTd>
                        <MudTd>@context.GamesPlayed</MudTd>
                        <MudTd>@context.GamesWon</MudTd>
                        <MudTd>@context.TotalScore</MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
            
            <MudExpansionPanels Class="mt-2 d-none d-sm-flex">
                <MudExpansionPanel Text="Show Additional Stats">
                    <MudTable Items="@Players" 
                             Dense="true" 
                             Hover="true" 
                             Bordered="false" 
                             Striped="true"
                             Class="leaderboard-table">
                        <HeaderContent>
                            <MudTh>Rank</MudTh>
                            <MudTh>Player</MudTh>
                            <MudTh>Win %</MudTh>
                            <MudTh>Avg Score</MudTh>
                            <MudTh>Correct</MudTh>
                            <MudTh>Accuracy</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Rank</MudTd>
                            <MudTd>
                                <MudChip T="string" Color="@GetPlayerColor(context.Rank)" Size="Size.Small">@context.Initials</MudChip>
                            </MudTd>
                            <MudTd>@($"{(double)context.GamesWon / Math.Max(1, context.GamesPlayed):P0}")</MudTd>
                            <MudTd>@($"{(double)context.TotalScore / Math.Max(1, context.GamesPlayed):F1}")</MudTd>
                            <MudTd>@context.TotalCorrectAnswers</MudTd>
                            <MudTd>@($"{(double)context.TotalCorrectAnswers / (Math.Max(1, context.GamesPlayed) * 10):P0}")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
        
        <div class="d-flex justify-center mt-3">
            <MudButton Variant="Variant.Filled" 
                     Color="Color.Primary" 
                     Href="/"
                     Class="my-2">
                BACK TO MAIN MENU
            </MudButton>
        </div>
    </MudPaper>
</MudContainer>

<style>
    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }
    
    @@media (max-width: 600px) {
        .leaderboard-table {
            font-size: 0.85rem;
        }
        
        .mud-table-cell {
            padding: 8px 6px;
        }
    }
</style>

@code {
    private bool Loading { get; set; } = true;
    private string? ErrorMessage { get; set; }
    private List<Player> Players { get; set; } = new List<Player>();
    
    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initialized");
        await LoadLeaderboard();
    }
    
    private async Task LoadLeaderboard()
    {
        try
        {
            Logger.LogInformation("Starting to load leaderboard data");
            Loading = true;
            ErrorMessage = null;
            StateHasChanged();
            
            // Get all players from storage
            Logger.LogInformation("Calling PlayerService.GetAllPlayersAsync()");
            var allPlayers = await PlayerService.GetAllPlayersAsync();
            Logger.LogInformation("Retrieved {Count} players from storage", allPlayers.Count);
            
            // Log some details about the players for diagnostics
            foreach (var player in allPlayers.Take(3))
            {
                Logger.LogInformation("Player: Initials={Initials}, GamesPlayed={GamesPlayed}, LastPlayed={LastPlayed}",
                    player.Initials, player.GamesPlayed, player.LastPlayed);
            }
            
            // Sort and rank players by total score
            Players = allPlayers
                .OrderByDescending(p => p.TotalScore)
                .Take(10)
                .Select((p, index) => {
                    p.Rank = index + 1; // Add rank property
                    return p;
                })
                .ToList();
            
            Logger.LogInformation("Leaderboard loaded successfully with {Count} players", Players.Count);
            Loading = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load leaderboard");
            ErrorMessage = $"Failed to load leaderboard: {ex.Message}";
            Loading = false;
        }
    }
    
    // Helper method to get color for player rank
    private Color GetPlayerColor(int rank)
    {
        return rank switch
        {
            1 => Color.Warning,  // Gold
            2 => Color.Tertiary, // Silver
            3 => Color.Tertiary, // Bronze
            _ => Color.Default   // Default for other ranks
        };
    }
}