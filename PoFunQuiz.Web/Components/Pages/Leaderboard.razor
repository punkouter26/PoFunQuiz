@page "/leaderboard"
@using PoFunQuiz.Core.Models
@using PoFunQuiz.Core.Services
@using Microsoft.Extensions.Logging
@using Azure.Data.Tables
@using System.Text.Json
@using Microsoft.Extensions.Hosting
@inject NavigationManager Navigation
@inject IPlayerStorageService PlayerService
@inject IGameSessionService GameSessionService
@inject ILogger<Leaderboard> Logger
@inject IHostEnvironment HostEnvironment
@inject IJSRuntime JSRuntime

<PageTitle>PoFunQuiz</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-2 px-1 px-sm-4">
    <MudPaper Elevation="3" Class="pa-2 pa-sm-4">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-2">Leaderboard</MudText>
        
        @if (Loading)
        {
            <div class="d-flex justify-center my-2">
                <MudProgressCircular Color="Color.Primary" Size="Size.Medium" Indeterminate="true" />
            </div>
        }
        else if (ErrorMessage != null)
        {
            <MudAlert Severity="Severity.Error" Class="my-2" Dense="true">@ErrorMessage</MudAlert>
            <div class="d-flex flex-column align-center">
                <MudButton Variant="Variant.Filled" 
                         Color="Color.Primary"
                         OnClick="LoadLeaderboard"
                         Size="Size.Small"
                         Class="my-2">
                    RETRY
                </MudButton>
            </div>
        }
        else if (Players.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Class="my-2" Dense="true">
                No player data available yet. Play some games to populate the leaderboard!
            </MudAlert>
        }
        else
        {
            
            <!-- Individual Player Statistics -->
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-3">Player Leaderboard & Statistics</MudText>
            <MudTable Items="@Players" 
                     Dense="true" 
                     Hover="true" 
                     Bordered="false" 
                     Striped="true"
                     Breakpoint="Breakpoint.None"
                     Class="leaderboard-table">
                <HeaderContent>
                    <MudTh>Rank</MudTh>
                    <MudTh>Player</MudTh>
                    <MudTh>Games</MudTh>
                    <MudTh>Wins</MudTh>
                    <MudTh>Score</MudTh>
                    <MudTh>Win %</MudTh>
                    <MudTh>Avg Score</MudTh>
                    <MudTh>Correct</MudTh>
                    <MudTh>Accuracy</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        @if (context.Rank <= 3)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" 
                                     Color="@(context.Rank == 1 ? Color.Warning : context.Rank == 2 ? Color.Tertiary : Color.Tertiary)" 
                                     Size="Size.Small" />
                        }
                        @context.Rank
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Color="@GetPlayerColor(context.Rank)" Size="Size.Small">@context.Initials</MudChip>
                    </MudTd>
                    <MudTd>@context.GamesPlayed</MudTd>
                    <MudTd>@context.GamesWon</MudTd>
                    <MudTd>@context.TotalScore</MudTd>
                    <MudTd>@($"{(double)context.GamesWon / Math.Max(1, context.GamesPlayed):P0}")</MudTd>
                    <MudTd>@($"{(double)context.TotalScore / Math.Max(1, context.GamesPlayed):F1}")</MudTd>
                    <MudTd>@context.TotalCorrectAnswers</MudTd>
                    <MudTd>@($"{(double)context.TotalCorrectAnswers / (Math.Max(1, context.GamesPlayed) * 10):P0}")</MudTd>
                </RowTemplate>
            </MudTable>
            
            <!-- Global Statistics -->
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle1" Class="mb-2">Global Statistics</MudText>
            
            <MudGrid>
                <!-- Total Questions Answered -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="0" Class="pa-3" Outlined>
                        <MudText Typo="Typo.subtitle2">Questions Summary</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.QuestionAnswer" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Total Questions Asked: @TotalQuestionsAsked</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Total Correct Answers: @TotalCorrectAnswers</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Percent" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Overall Accuracy: @($"{OverallAccuracy:P1}")</MudText>
                                </div>
                            </MudListItem>
                        </MudList>
                    </MudPaper>
                </MudItem>

                <!-- Game Statistics -->
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="0" Class="pa-3" Outlined>
                        <MudText Typo="Typo.subtitle2">Game Summary</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.SportsEsports" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Total Games Played: @TotalGamesPlayed</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Average Game Duration: @AverageGameDuration</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem T="string">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiPeople" Class="mr-2" />
                                    <MudText Typo="Typo.body2">Total Players: @Players.Count</MudText>
                                </div>
                            </MudListItem>
                        </MudList>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            
            <!-- Daily Activity Charts -->
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle1" Class="mb-2">Daily Activity</MudText>
            
            <!-- Games Per Day -->
            <MudPaper Elevation="0" Class="pa-3 mb-3" Outlined>
                <MudText Typo="Typo.subtitle2" Class="mb-2">Games Played Per Day</MudText>
                <div class="chart-container">
                    @foreach (var dayData in GamesPlayedPerDay.OrderBy(d => d.Key))
                    {
                        var barHeight = Math.Max(20, Math.Min(100, dayData.Value * 10));
                        <div class="chart-item">
                            <div class="chart-bar" style="height: @(barHeight)px; background-color: var(--mud-palette-primary);">
                                <span class="chart-value">@dayData.Value</span>
                            </div>
                            <div class="chart-label">@FormatDayLabel(dayData.Key)</div>
                        </div>
                    }
                </div>
            </MudPaper>
            
            <!-- Questions Per Day -->
            <MudPaper Elevation="0" Class="pa-3 mb-3" Outlined>
                <MudText Typo="Typo.subtitle2" Class="mb-2">Questions Asked Per Day</MudText>
                <div class="chart-container">
                    @foreach (var dayData in QuestionsAskedPerDay.OrderBy(d => d.Key))
                    {
                        var barHeight = Math.Max(20, Math.Min(100, dayData.Value * 5));
                        <div class="chart-item">
                            <div class="chart-bar" style="height: @(barHeight)px; background-color: var(--mud-palette-secondary);">
                                <span class="chart-value">@dayData.Value</span>
                            </div>
                            <div class="chart-label">@FormatDayLabel(dayData.Key)</div>
                        </div>
                    }
                </div>
            </MudPaper>
            
        }
        
        <div class="d-flex justify-center mt-3">
            <MudButton Variant="Variant.Filled" 
                     Color="Color.Primary" 
                     Href="/"
                     Size="Size.Small"
                     Class="my-2">
                BACK TO MAIN MENU
            </MudButton>
        </div>
    </MudPaper>
</MudContainer>

<style>
    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }
    
    .chart-container {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 140px;
        gap: 8px;
    }
    
    .chart-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 40px;
    }
    
    .chart-bar {
        width: 30px;
        border-radius: 4px 4px 0 0;
        position: relative;
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }
    
    .chart-value {
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 2px;
    }
    
    .chart-label {
        font-size: 10px;
        margin-top: 4px;
        text-align: center;
    }
    
    .accuracy-chart {
        flex-direction: column;
        height: auto;
        align-items: stretch;
    }
    
    .accuracy-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .accuracy-label {
        flex: 0 0 40px;
        text-align: center;
        font-weight: bold;
    }
    
    .accuracy-bar-container {
        flex: 1;
        background-color: rgba(0,0,0,0.05);
        border-radius: 4px;
        overflow: hidden;
        height: 24px;
    }
    
    .accuracy-bar {
        background-color: var(--mud-palette-primary);
        height: 100%;
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding-left: 8px;
        color: white;
        font-size: 12px;
    }
    
    @@media (max-width: 600px) {
        .leaderboard-table {
            font-size: 0.75rem;
        }
        
        .mud-table-cell {
            padding: 4px 3px;
        }
        
        .mud-chip {
            height: 24px;
            font-size: 0.7rem;
        }
        
        .mud-chip-icon {
            font-size: 1rem;
            margin-right: 2px;
        }
        
        .mud-container {
            padding: 0.5rem !important;
        }
        
        .mud-paper {
            padding: 8px !important;
        }
        
        .mud-typography-h5 {
            font-size: 1.1rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .chart-container {
            height: 100px;
        }
        
        .chart-item {
            width: 30px;
        }
        
        .chart-bar {
            width: 20px;
        }
    }
</style>

@code {
    private bool Loading { get; set; } = true;
    private string? ErrorMessage { get; set; }
    private List<Player> Players { get; set; } = new List<Player>();
    private List<GameSession> RecentGames { get; set; } = new List<GameSession>();
    
    // Global statistics
    private int TotalGamesPlayed => Players.Sum(p => p.GamesPlayed);
    private int TotalQuestionsAsked => TotalGamesPlayed * 20; // 10 questions per player, 2 players per game
    private int TotalCorrectAnswers => Players.Sum(p => p.TotalCorrectAnswers);
    private double OverallAccuracy => TotalQuestionsAsked > 0 ? (double)TotalCorrectAnswers / TotalQuestionsAsked : 0;
    private string AverageGameDuration => CalculateAverageGameDuration();
    
    // Daily statistics
    private Dictionary<DateTime, int> GamesPlayedPerDay { get; set; } = new Dictionary<DateTime, int>();
    private Dictionary<DateTime, int> QuestionsAskedPerDay { get; set; } = new Dictionary<DateTime, int>();
    
    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initialized");
        await LoadLeaderboard();
    }
    
    private async Task LoadLeaderboard()
    {
        try
        {
            Logger.LogInformation("Starting to load leaderboard data");
            Loading = true;
            ErrorMessage = null;
            StateHasChanged();
            
            // Get all players from storage
            Logger.LogInformation("Calling PlayerService.GetAllPlayersAsync()");
            var allPlayers = await PlayerService.GetAllPlayersAsync();
            Logger.LogInformation("Retrieved {Count} players from storage", allPlayers.Count);
            
            // Log some details about the players for diagnostics
            foreach (var player in allPlayers.Take(3))
            {
                Logger.LogInformation("Player: Initials={Initials}, GamesPlayed={GamesPlayed}, LastPlayed={LastPlayed}",
                    player.Initials, player.GamesPlayed, player.LastPlayed);
            }
            
            // Get recent game sessions - explicitly pass default(string?) which is null
            RecentGames = await GameSessionService.GetRecentGameSessionsAsync(default(string?), 50); 
            Logger.LogInformation("Retrieved {Count} recent game sessions", RecentGames.Count);
            
            // Calculate per-day statistics
            CalculateDailyStatistics();
            
            // Sort and rank players by total score
            Players = allPlayers
                .OrderByDescending(p => p.TotalScore)
                .Take(10)
                .Select((p, index) => {
                    p.Rank = index + 1; // Add rank property
                    return p;
                })
                .ToList();
            
            Logger.LogInformation("Leaderboard loaded successfully with {Count} players", Players.Count);
            Loading = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load leaderboard");
            ErrorMessage = $"Failed to load leaderboard: {ex.Message}";
            Loading = false;
        }
    }
    
    // Calculate daily statistics
    private void CalculateDailyStatistics()
    {
        GamesPlayedPerDay.Clear();
        QuestionsAskedPerDay.Clear();
        
        // Default data for the last 7 days if there's no actual data
        var today = DateTime.Today;
        for (int i = 6; i >= 0; i--)
        {
            var day = today.AddDays(-i);
            GamesPlayedPerDay[day] = 0;
            QuestionsAskedPerDay[day] = 0;
        }
        
        // Process real data from game sessions
        foreach (var game in RecentGames.Where(g => g.EndTime.HasValue))
        {
            var gameDate = game.EndTime!.Value.Date;
            
            // Add or update games per day
            if (GamesPlayedPerDay.ContainsKey(gameDate))
                GamesPlayedPerDay[gameDate]++;
            else
                GamesPlayedPerDay[gameDate] = 1;
            
            // Add or update questions per day (20 questions per game - 10 for each player)
            if (QuestionsAskedPerDay.ContainsKey(gameDate))
                QuestionsAskedPerDay[gameDate] += 20;
            else
                QuestionsAskedPerDay[gameDate] = 20;
        }
        
        // Keep only the 7 most recent days with data
        GamesPlayedPerDay = GamesPlayedPerDay
            .OrderByDescending(d => d.Key)
            .Take(7)
            .ToDictionary(d => d.Key, d => d.Value);
            
        QuestionsAskedPerDay = QuestionsAskedPerDay
            .OrderByDescending(d => d.Key)
            .Take(7)
            .ToDictionary(d => d.Key, d => d.Value);
    }
    
    // Calculate average game duration
    private string CalculateAverageGameDuration()
    {
        if (RecentGames.Count == 0)
            return "0:00";
            
        var completedGames = RecentGames.Where(g => g.StartTime.HasValue && g.EndTime.HasValue).ToList();
        if (completedGames.Count == 0)
            return "0:00";
            
        var totalDuration = completedGames.Sum(g => (g.EndTime!.Value - g.StartTime!.Value).TotalSeconds);
        var averageSeconds = totalDuration / completedGames.Count;
        
        var minutes = (int)(averageSeconds / 60);
        var seconds = (int)(averageSeconds % 60);
        
        return $"{minutes}:{seconds:00}";
    }
    
    // Format date for chart labels
    private string FormatDayLabel(DateTime date)
    {
        return date.ToString("MM/dd");
    }
    
    // Helper method to get color for player rank
    private Color GetPlayerColor(int rank)
    {
        return rank switch
        {
            1 => Color.Warning,  // Gold
            2 => Color.Tertiary, // Silver
            3 => Color.Tertiary, // Bronze
            _ => Color.Default   // Default for other ranks
        };
    }
}
