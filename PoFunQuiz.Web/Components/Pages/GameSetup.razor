@page "/game-setup"
@using PoFunQuiz.Core.Services
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation
@inject IQuestionGeneratorService QuestionService
@inject GameState GameState
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>PoFunQuiz - Game Setup</PageTitle>

@if (GameState.CurrentGame == null)
{
    <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
        <MudText Typo="Typo.h4" Class="mb-4">Game session not found.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">Return to Main Menu</MudButton>
    </MudContainer>
}
else
{
    <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
        <div @onkeydown="HandleKeyDown" tabindex="0" @ref="containerElement" style="width: 100%; height: 100%; outline: none;">
            @if (IsLoading)
            {
                <MudText Typo="Typo.h4" Class="mb-4">Generating Questions...</MudText>
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            }
            else if (IsCountingDown)
            {
                <MudText Typo="Typo.h2" Color="Color.Primary">Get Ready!</MudText>
                <MudText Typo="Typo.h1" Style="font-size: 10rem;" Color="Color.Secondary">@CountdownValue</MudText>
            }
            else if (ErrorMessage != null)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RetrySetup">Retry</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="/" Class="mt-2">Back to Main Menu</MudButton>
            }
            else
            {
                <MudGrid>
                    <MudItem xs="6">
                        <MudCard Class="pa-4 d-flex flex-column align-center">
                            <MudText Typo="Typo.h4" Color="Color.Primary">Player 1</MudText>
                            <MudAvatar Color="Color.Primary" Size="Size.Large" Class="ma-4">@GameState.CurrentGame.Player1.Initials</MudAvatar>
                            <MudText Typo="Typo.body1" Class="mb-4">Use keys 1-4 to answer</MudText>
                            @if (!Player1Ready)
                            {
                                <MudButton Variant="Variant.Filled" 
                                        Color="Color.Primary" 
                                        OnClick="@(() => SetPlayerReady(1))">
                                    I'm Ready
                                </MudButton>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.Check">Ready!</MudChip>
                            }
                        </MudCard>
                    </MudItem>
                    
                    <MudItem xs="6">
                        <MudCard Class="pa-4 d-flex flex-column align-center">
                            <MudText Typo="Typo.h4" Color="Color.Secondary">Player 2</MudText>
                            <MudAvatar Color="Color.Secondary" Size="Size.Large" Class="ma-4">@GameState.CurrentGame.Player2.Initials</MudAvatar>
                            <MudText Typo="Typo.body1" Class="mb-4">Use keys 6-9 to answer</MudText>
                            @if (!Player2Ready)
                            {
                                <MudButton Variant="Variant.Filled" 
                                        Color="Color.Secondary" 
                                        OnClick="@(() => SetPlayerReady(2))">
                                    I'm Ready
                                </MudButton>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.Check">Ready!</MudChip>
                            }
                        </MudCard>
                    </MudItem>
                </MudGrid>
            }
        </div>
    </MudContainer>
}

@code {
    private bool Player1Ready { get; set; } = false;
    private bool Player2Ready { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private bool IsCountingDown { get; set; } = false;
    private int CountdownValue { get; set; } = 3;
    private string ErrorMessage { get; set; }
    private System.Threading.Timer _countdownTimer;
    private ElementReference containerElement;
    
    protected override void OnInitialized()
    {
        // Redirect to home if no game session exists
        if (GameState.CurrentGame == null)
        {
            Navigation.NavigateTo("/");
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set focus to the container to enable keyboard events
            await JSRuntime.InvokeVoidAsync("focusElement", containerElement);
        }
    }
    
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        // Handle Player 1 ready (any of keys 1-4)
        if (!Player1Ready && (e.Key == "1" || e.Key == "2" || e.Key == "3" || e.Key == "4"))
        {
            SetPlayerReady(1);
        }
        
        // Handle Player 2 ready (any of keys 6-9)
        if (!Player2Ready && (e.Key == "6" || e.Key == "7" || e.Key == "8" || e.Key == "9"))
        {
            SetPlayerReady(2);
        }
    }
    
    private void SetPlayerReady(int playerNumber)
    {
        if (playerNumber == 1)
            Player1Ready = true;
        else
            Player2Ready = true;
            
        // Check if both players are ready
        if (Player1Ready && Player2Ready)
        {
            StartCountdown();
        }
        
        StateHasChanged();
    }
    
    private void StartCountdown()
    {
        IsCountingDown = true;
        _countdownTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                CountdownValue--;
                StateHasChanged();
                
                if (CountdownValue <= 0)
                {
                    _countdownTimer?.Dispose();
                    _countdownTimer = null;
                    IsCountingDown = false;
                    await GenerateQuestions();
                }
            });
        }, null, 0, 1000);
    }
    
    private async Task GenerateQuestions()
    {
        try
        {
            IsLoading = true;
            StateHasChanged();
            
            // Generate exactly 10 unique questions for both players
            var questions = await QuestionService.GenerateQuestionsAsync(10);
            
            if (questions == null || questions.Count < 10)
            {
                ErrorMessage = "Failed to generate enough questions. Please try again.";
                IsLoading = false;
                StateHasChanged();
                return;
            }
            
            // Ensure we have exactly 10 questions
            var uniqueQuestions = questions.Take(10).ToList();
            
            // Assign the same set of questions to both players
            GameState.CurrentGame.Player1Questions = uniqueQuestions;
            GameState.CurrentGame.Player2Questions = uniqueQuestions;
            
            // Navigate to game board
            Navigation.NavigateTo("/game-board");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
            IsLoading = false;
            StateHasChanged();
        }
    }
    
    private void RetrySetup()
    {
        ErrorMessage = null;
        Player1Ready = false;
        Player2Ready = false;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        _countdownTimer?.Dispose();
    }
}