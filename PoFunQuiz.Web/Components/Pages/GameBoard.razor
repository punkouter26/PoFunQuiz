@page "/game-board"
@using PoFunQuiz.Core.Services
@using PoFunQuiz.Core.Models
@using System.Timers
@using System.Diagnostics
@inject NavigationManager Navigation
@inject IGameSessionService GameSessionService
@inject GameState GameState
@inject ConnectionState ConnectionState
@inject IJSRuntime JS
@inject ILogger<GameBoard> Logger
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>PoFunQuiz - Game</PageTitle>

<!-- Import the separate CSS file for mobile styles -->
<link href="css/gameboard-mobile.css" rel="stylesheet" />

<div class="game-page">
    @if (!isConnected)
    {
        <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
            <MudText Typo="Typo.h4" Class="mb-4">Connection Lost!</MudText>
            <MudText Class="mb-4">Attempting to reconnect... (@reconnectCountdown)</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ReloadPage">Reload Page</MudButton>
        </MudContainer>
    }
    else if (GameState.CurrentGame == null || 
         GameState.CurrentGame.Player1Questions == null || 
         GameState.CurrentGame.Player2Questions == null)
    {
        <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 85vh;">
            <MudText Typo="Typo.h4" Class="mb-4">Game session not ready.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">Return to Main Menu</MudButton>
        </MudContainer>
    }
    else
    {
        <div @onkeydown="HandleKeyDown" tabindex="0" @ref="gameContainer" id="gameContainer" @onclick="FocusGameContainer" class="game-container">
            <MudContainer MaxWidth="MaxWidth.Large" Class="pa-2 mt-2">
                <!-- Game Timer -->
                <MudPaper Elevation="3" Class="d-flex justify-center align-center pa-1 mb-2" Style="background: linear-gradient(to right, #6a11cb, #2575fc); color: white;">
                    <MudText Typo="Typo.body1" Color="@(TimeRemaining <= 10 ? Color.Error : Color.Default)">
                        Time: @TimeRemaining s
                    </MudText>
                </MudPaper>
                
                <!-- Global Controls - Results and Menu buttons -->
                @if (Player1HasFinished && Player2HasFinished)
                {
                    <MudPaper Elevation="2" Class="d-flex justify-center align-center pa-2 mb-2" Style="border-radius: 8px;">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/results" Class="mx-1" Size="Size.Small">
                            Results
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="/" Class="mx-1" Size="Size.Small">
                            Menu
                        </MudButton>
                    </MudPaper>
                }
                
                <MudGrid Class="pa-0 ma-0 game-grid" Style="height: auto;">
                    <!-- Player 1 Side -->
                    <MudItem xs="12" md="6" Class="pa-1 player-column" Style="height: 100%;">
                        <MudPaper Class="pa-1" Style="height: 100%; position: relative; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" Elevation="2">
                            <div class="d-flex justify-space-between align-center mb-1">
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Style="margin-right: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" Size="Size.Small">
                                        @GameState.CurrentGame.Player1.Initials
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2">P1</MudText>
                                </div>
                                <div class="score-container">
                                    <MudText Typo="Typo.body2" Style="font-weight: bold;">@Player1Score</MudText>
                                </div>
                            </div>
                            
                            <MudProgressLinear Value="@((Player1QuestionIndex + 1) * 10)" Color="Color.Primary" Class="my-1" Style="height: 4px; border-radius: 2px;" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-1">
                                @if (Player1HasFinished)
                                {
                                    <span style="font-weight: bold; color: #2e7d32;">DONE!</span>
                                }
                                else
                                {
                                    <text>Q @(Player1QuestionIndex + 1)/10</text>
                                }
                            </MudText>
                            
                            @if (Player1HasFinished)
                            {
                                <div class="d-flex flex-column align-center justify-center" style="height: 80%;">
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                                    <MudText Typo="Typo.body1" Color="Color.Success" Class="mt-1">Quiz Complete!</MudText>
                                    <MudText Typo="Typo.body2" Class="mt-1">Time Bonus: +@Player1TimeBonus</MudText>
                                    <MudText Typo="Typo.body2">Final: @(Player1Score + Player1TimeBonus)</MudText>
                                    
                                    @if (Player2HasFinished)
                                    {
                                        <MudText Typo="Typo.caption" Class="mt-1">Both players finished!</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Class="mt-1">Waiting for P2...</MudText>
                                    }
                                </div>
                            }
                            else if (Player1QuestionIndex < GameState.CurrentGame.Player1Questions.Count)
                            {
                                <!-- Optimized question container for Player 1 -->
                                <MudPaper Elevation="0" Class="question-container compact-question pa-1 mb-1" Style="background-color: #f5f5f5; border-radius: 6px; overflow-y: auto;">
                                    <MudText Typo="Typo.body2" Class="question-text" Style="font-weight: 500; color: #333;">
                                        @GameState.CurrentGame.Player1Questions[Player1QuestionIndex].Text
                                    </MudText>
                                </MudPaper>
                                
                                <MudList T="string" Dense="true" disableGutters="true" Class="pa-0 answer-list">
                                    @foreach (var (option, index) in GameState.CurrentGame.Player1Questions[Player1QuestionIndex].Options.Select((o, i) => (o, i)))
                                    {
                                        var optionIndex = index;
                                        var isSelected = Player1Selections.Contains(optionIndex);
                                        <MudListItem T="string" 
                                                   Class="@(isSelected ? "selected-option answer-option" : "answer-option")"
                                                   Style="border-radius: 4px; margin-bottom: 4px; transition: all 0.2s ease; padding: 4px 6px;"
                                                   OnClick="() => HandlePlayerAnswer(1, optionIndex)">
                                            <div class="d-flex align-center">
                                                <MudAvatar Color="Color.Primary" Size="Size.Small" Style="margin-right: 8px; height: 24px; width: 24px; min-width: 24px;">@(optionIndex + 1)</MudAvatar>
                                                <MudText Typo="Typo.caption" Style="overflow: hidden; text-overflow: ellipsis;">@option</MudText>
                                            </div>
                                        </MudListItem>
                                    }
                                </MudList>
                                
                                <MudText Typo="Typo.caption" Class="mt-1 d-block d-md-none" Style="color: #666;">
                                    Keys 1-4
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                    
                    <!-- Player 2 Side -->
                    <MudItem xs="12" md="6" Class="pa-1 player-column" Style="height: 100%;">
                        <MudPaper Class="pa-1" Style="height: 100%; position: relative; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" Elevation="2">
                            <div class="d-flex justify-space-between align-center mb-1">
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Secondary" Style="margin-right: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);" Size="Size.Small">
                                        @GameState.CurrentGame.Player2.Initials
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2">P2</MudText>
                                </div>
                                <div class="score-container">
                                    <MudText Typo="Typo.body2" Style="font-weight: bold;">@Player2Score</MudText>
                                </div>
                            </div>
                            
                            <MudProgressLinear Value="@((Player2QuestionIndex + 1) * 10)" Color="Color.Secondary" Class="my-1" Style="height: 4px; border-radius: 2px;" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-1">
                                @if (Player2HasFinished)
                                {
                                    <span style="font-weight: bold; color: #2e7d32;">DONE!</span>
                                }
                                else
                                {
                                    <text>Q @(Player2QuestionIndex + 1)/10</text>
                                }
                            </MudText>
                            
                            @if (Player2HasFinished)
                            {
                                <div class="d-flex flex-column align-center justify-center" style="height: 80%;">
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                                    <MudText Typo="Typo.body1" Color="Color.Success" Class="mt-1">Quiz Complete!</MudText>
                                    <MudText Typo="Typo.body2" Class="mt-1">Time Bonus: +@Player2TimeBonus</MudText>
                                    <MudText Typo="Typo.body2">Final: @(Player2Score + Player2TimeBonus)</MudText>
                                    
                                    @if (Player1HasFinished)
                                    {
                                        <MudText Typo="Typo.caption" Class="mt-1">Both players finished!</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.caption" Class="mt-1">Waiting for P1...</MudText>
                                    }
                                </div>
                            }
                            else if (Player2QuestionIndex < GameState.CurrentGame.Player2Questions.Count)
                            {
                                <!-- Optimized question container for Player 2 -->
                                <MudPaper Elevation="0" Class="question-container compact-question pa-1 mb-1" Style="background-color: #f5f5f5; border-radius: 6px; overflow-y: auto;">
                                    <MudText Typo="Typo.body2" Class="question-text" Style="font-weight: 500; color: #333;">
                                        @GameState.CurrentGame.Player2Questions[Player2QuestionIndex].Text
                                    </MudText>
                                </MudPaper>
                                
                                <MudList T="string" Dense="true" disableGutters="true" Class="pa-0 answer-list">
                                    @foreach (var (option, index) in GameState.CurrentGame.Player2Questions[Player2QuestionIndex].Options.Select((o, i) => (o, i)))
                                    {
                                        var optionIndex = index;
                                        var isSelected = Player2Selections.Contains(optionIndex);
                                        <MudListItem T="string" 
                                                   Class="@(isSelected ? "selected-option answer-option" : "answer-option")"
                                                   Style="border-radius: 4px; margin-bottom: 4px; transition: all 0.2s ease; padding: 4px 6px;"
                                                   OnClick="() => HandlePlayerAnswer(2, optionIndex)">
                                            <div class="d-flex align-center">
                                                <MudAvatar Color="Color.Secondary" Size="Size.Small" Style="margin-right: 8px; height: 24px; width: 24px; min-width: 24px;">@(optionIndex + 6)</MudAvatar>
                                                <MudText Typo="Typo.caption" Style="overflow: hidden; text-overflow: ellipsis;">@option</MudText>
                                            </div>
                                        </MudListItem>
                                    }
                                </MudList>
                                
                                <MudText Typo="Typo.caption" Class="mt-1 d-block d-md-none" Style="color: #666;">
                                    Keys 6-9
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        </div>
    }
</div>

<style>
    .game-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 20px;
    }
    
    .game-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    
    .answer-list {
        margin-bottom: 10px;
        overflow-y: auto;
        max-height: 200px;
    }
    
    .selected-option {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .score-container {
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 4px;
        padding: 2px 8px;
        min-width: 30px;
        text-align: center;
        margin-right: 4px;
    }
    
    /* Optimized question container */
    .compact-question {
        min-height: unset !important;
        max-height: 80px !important;
    }
    
    .question-text {
        line-height: 1.3 !important;
        margin: 0 !important;
    }
</style>

@code {
    private ElementReference gameContainer;
    private Timer? gameTimer;
    private Timer? feedbackTimer;
    private Timer? reconnectTimer;
    private int TimeRemaining { get; set; } = 60;
    private bool isConnected = true;
    private int reconnectCountdown = 10;
    private bool isInitialized = false;
    
    // Player 1 state
    private int Player1QuestionIndex { get; set; } = 0;
    private int Player1Score { get; set; } = 0;
    private int Player1TimeBonus { get; set; } = 0;
    private bool Player1HasFinished { get; set; } = false;
    private bool Player1FeedbackVisible { get; set; } = false;
    private bool Player1LastAnswerCorrect { get; set; } = false;
    private List<int> Player1Selections { get; set; } = new List<int>();
    
    // Player 2 state
    private int Player2QuestionIndex { get; set; } = 0;
    private int Player2Score { get; set; } = 0;
    private int Player2TimeBonus { get; set; } = 0;
    private bool Player2HasFinished { get; set; } = false;
    private bool Player2FeedbackVisible { get; set; } = false;
    private bool Player2LastAnswerCorrect { get; set; } = false;
    private List<int> Player2Selections { get; set; } = new List<int>();

    private DotNetObjectReference<GameBoard>? objRef;
    private bool isMobileDevice = false;

    protected override void OnInitialized()
    {
        try
        {
            Logger.LogInformation("üîµ GameBoard OnInitialized called at {Time}", DateTime.Now);
            Console.WriteLine($"üîµ GameBoard OnInitialized called at {DateTime.Now}");
            
            base.OnInitialized();
            
            // Check if we're already connected
            isConnected = ConnectionState.IsConnected;
            Logger.LogInformation("üîå Initial connection state is {State}", isConnected ? "Connected" : "Disconnected");
            Console.WriteLine($"üîå Initial connection state is {(isConnected ? "Connected" : "Disconnected")}");
            
            // Subscribe to connection state changes
            ConnectionState.ConnectionChanged += HandleConnectionChanged;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in OnInitialized: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in OnInitialized: {ex.Message}");
        }
    }
    
    private void HandleConnectionChanged(bool isConnected)
    {
        try
        {
            Logger.LogInformation("üì∂ Connection state changed to {IsConnected} at {Time}", 
                isConnected ? "Connected" : "Disconnected", DateTime.Now);
            Console.WriteLine($"üì∂ Connection state changed to {(isConnected ? "Connected" : "Disconnected")} at {DateTime.Now}");
            
            InvokeAsync(() => {
                this.isConnected = isConnected;
                
                if (!isConnected)
                {
                    Logger.LogInformation("‚è±Ô∏è Stopping game timer due to disconnection");
                    Console.WriteLine("‚è±Ô∏è Stopping game timer due to disconnection");
                    gameTimer?.Stop();
                    StartReconnectCountdown();
                }
                else if (isInitialized)
                {
                    Logger.LogInformation("‚è±Ô∏è Restarting game timer after reconnection");
                    Console.WriteLine("‚è±Ô∏è Restarting game timer after reconnection");
                    reconnectTimer?.Stop();
                    StartGameTimer();
                }
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in HandleConnectionChanged: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in HandleConnectionChanged: {ex.Message}");
        }
    }
    
    private async Task FocusGameContainer()
    {
        try
        {
            await JS.InvokeVoidAsync("focusGameContainer", "gameContainer");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error focusing game container");
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Logger.LogInformation("üîµ GameBoard first render at {Time}", DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss"));
                Console.WriteLine($"üîµ GameBoard first render at {DateTime.Now}");
                
                if (GameState.CurrentGame == null)
                {
                    Logger.LogWarning("‚ö†Ô∏è GameState.CurrentGame is null, navigating to home");
                    Console.WriteLine("‚ö†Ô∏è GameState.CurrentGame is null, navigating to home");
                    Navigation.NavigateTo("/");
                    return;
                }
                
                // Set focus to the container to enable keyboard events
                await JS.InvokeVoidAsync("focusElement", gameContainer);
                
                // Check if we're on a mobile device
                isMobileDevice = await JS.InvokeAsync<bool>("isMobileDevice");
                Logger.LogInformation("Game board initialized. Mobile device: {IsMobile}", isMobileDevice);
                
                if (isMobileDevice)
                {
                    // Add touch support for mobile devices
                    objRef = DotNetObjectReference.Create(this);
                    await JS.InvokeVoidAsync("addTouchSupport", "gameContainer", objRef);
                }
                
                // Start the game timer
                StartGameTimer();
                
                isInitialized = true;
                Logger.LogInformation("‚úÖ GameBoard initialization complete");
                Console.WriteLine("‚úÖ GameBoard initialization complete");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "‚ùå Error during GameBoard first render: {Message}", ex.Message);
                Console.WriteLine($"‚ùå Error during GameBoard first render: {ex.Message}");
            }
        }
        else
        {
            try
            {
                // Add touch feedback after each render to ensure new options get the handlers
                await JS.InvokeVoidAsync("addTouchFeedback");
            }
            catch (Exception ex)
            {
                // Log the error but don't crash the component
                Logger.LogWarning(ex, "‚ö†Ô∏è Error adding touch feedback: {Message}", ex.Message);
                Console.WriteLine($"‚ö†Ô∏è Error adding touch feedback: {ex.Message}");
            }
        }
    }

    private void StartGameTimer()
    {
        try
        {
            Logger.LogInformation("‚è±Ô∏è StartGameTimer called at {Time}", DateTime.Now);
            Console.WriteLine($"‚è±Ô∏è StartGameTimer called at {DateTime.Now}");
            
            gameTimer?.Stop();
            gameTimer?.Dispose();
            
            gameTimer = new Timer(1000);
            gameTimer.Elapsed += OnGameTimerElapsed;
            gameTimer.AutoReset = true;
            gameTimer.Enabled = true;
            
            Logger.LogInformation("‚úÖ Game timer successfully started");
            Console.WriteLine("‚úÖ Game timer successfully started");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error starting game timer: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error starting game timer: {ex.Message}");
        }
    }
    
    private void OnGameTimerElapsed(object sender, ElapsedEventArgs e)
    {
        try
        {
            InvokeAsync(() => 
            {
                TimeRemaining--;
                
                if (TimeRemaining % 5 == 0 || TimeRemaining <= 10)
                {
                    Logger.LogInformation("‚è±Ô∏è Timer update: {TimeRemaining} seconds remaining at {Time}", 
                        TimeRemaining, DateTime.Now);
                    Console.WriteLine($"‚è±Ô∏è Timer update: {TimeRemaining} seconds remaining at {DateTime.Now}");
                }
                
                if (TimeRemaining <= 0)
                {
                    Logger.LogInformation("‚è±Ô∏è Timer reached zero, ending game");
                    Console.WriteLine("‚è±Ô∏è Timer reached zero, ending game");
                    EndGame();
                }
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in timer callback: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in timer callback: {ex.Message}");
        }
    }

    private void StartReconnectCountdown()
    {
        Logger.LogInformation("‚è±Ô∏è StartReconnectCountdown called at {Time}", DateTime.Now);
        Console.WriteLine($"‚è±Ô∏è StartReconnectCountdown called at {DateTime.Now}");
        
        reconnectTimer?.Dispose();
        reconnectCountdown = 10;
        
        reconnectTimer = new Timer(1000);
        reconnectTimer.Elapsed += (sender, e) => {
            InvokeAsync(() => {
                reconnectCountdown--;
                Logger.LogInformation("‚è±Ô∏è Reconnect countdown: {Countdown} seconds", reconnectCountdown);
                Console.WriteLine($"‚è±Ô∏è Reconnect countdown: {reconnectCountdown} seconds");
                
                if (reconnectCountdown <= 0)
                {
                    Logger.LogInformation("‚è±Ô∏è Reconnect countdown expired, reloading page");
                    Console.WriteLine("‚è±Ô∏è Reconnect countdown expired, reloading page");
                    ReloadPage();
                }
                StateHasChanged();
            });
        };
        reconnectTimer.AutoReset = true;
        reconnectTimer.Enabled = true;
    }

    private void ReloadPage()
    {
        Logger.LogInformation("üîÑ Reloading page at {Time}", DateTime.Now);
        Console.WriteLine($"üîÑ Reloading page at {DateTime.Now}");
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
    
    private string GetOptionClass(int playerNumber, int optionIndex)
    {
        if (playerNumber == 1)
        {
            return Player1Selections.Contains(optionIndex) ? "selected-option" : "";
        }
        else
        {
            return Player2Selections.Contains(optionIndex) ? "selected-option" : "";
        }
    }
    
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        try
        {
            Logger.LogInformation("‚å®Ô∏è Key pressed: {Key} at {Time}", e.Key, DateTime.Now);
            Console.WriteLine($"‚å®Ô∏è Key pressed: {e.Key} at {DateTime.Now}");
            
            // Handle Player 1 inputs (keys 1-4)
            if (!Player1HasFinished && (e.Key == "1" || e.Key == "2" || e.Key == "3" || e.Key == "4"))
            {
                int index = int.Parse(e.Key) - 1;
                Logger.LogInformation("‚å®Ô∏è Player 1 selected option {Index}", index + 1);
                Console.WriteLine($"‚å®Ô∏è Player 1 selected option {index + 1}");
                HandlePlayerAnswer(1, index);
            }
            
            // Handle Player 2 inputs (keys 6-9)
            if (!Player2HasFinished && (e.Key == "6" || e.Key == "7" || e.Key == "8" || e.Key == "9"))
            {
                int index = int.Parse(e.Key) - 6;
                Logger.LogInformation("‚å®Ô∏è Player 2 selected option {Index}", index + 1);
                Console.WriteLine($"‚å®Ô∏è Player 2 selected option {index + 1}");
                HandlePlayerAnswer(2, index);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error handling keyboard input: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error handling keyboard input: {ex.Message}");
        }
    }
    
    private void HandlePlayerAnswer(int playerNumber, int selectedOptionIndex)
    {
        try
        {
            Logger.LogInformation("üéÆ HandlePlayerAnswer called for Player {PlayerNumber}, option {OptionIndex}", 
                playerNumber, selectedOptionIndex);
            Console.WriteLine($"üéÆ HandlePlayerAnswer called for Player {playerNumber}, option {selectedOptionIndex}");
            
            if (playerNumber == 1 && !Player1HasFinished && Player1QuestionIndex < GameState.CurrentGame.Player1Questions.Count)
            {
                var currentQuestion = GameState.CurrentGame.Player1Questions[Player1QuestionIndex];
                bool isCorrect = selectedOptionIndex == currentQuestion.CorrectOptionIndex;
                
                Player1LastAnswerCorrect = isCorrect;
                Player1FeedbackVisible = true;
                Player1Selections.Add(selectedOptionIndex);
                
                if (isCorrect)
                {
                    Player1Score += 1;
                    Logger.LogInformation("‚úÖ Player 1 answered correctly, score is now {Score}", Player1Score);
                    Console.WriteLine($"‚úÖ Player 1 answered correctly, score is now {Player1Score}");
                }
                else
                {
                    Logger.LogInformation("‚ùå Player 1 answered incorrectly");
                    Console.WriteLine("‚ùå Player 1 answered incorrectly");
                }
                
                ShowFeedbackThenAdvance(playerNumber);
            }
            else if (playerNumber == 2 && !Player2HasFinished && Player2QuestionIndex < GameState.CurrentGame.Player2Questions.Count)
            {
                var currentQuestion = GameState.CurrentGame.Player2Questions[Player2QuestionIndex];
                bool isCorrect = selectedOptionIndex == currentQuestion.CorrectOptionIndex;
                
                Player2LastAnswerCorrect = isCorrect;
                Player2FeedbackVisible = true;
                Player2Selections.Add(selectedOptionIndex);
                
                if (isCorrect)
                {
                    Player2Score += 1;
                    Logger.LogInformation("‚úÖ Player 2 answered correctly, score is now {Score}", Player2Score);
                    Console.WriteLine($"‚úÖ Player 2 answered correctly, score is now {Player2Score}");
                }
                else
                {
                    Logger.LogInformation("‚ùå Player 2 answered incorrectly");
                    Console.WriteLine("‚ùå Player 2 answered incorrectly");
                }
                
                ShowFeedbackThenAdvance(playerNumber);
            }
            else
            {
                Logger.LogWarning("‚ö†Ô∏è HandlePlayerAnswer called in invalid state. Player: {Player}, HasFinished: {HasFinished}", 
                    playerNumber, playerNumber == 1 ? Player1HasFinished : Player2HasFinished);
                Console.WriteLine($"‚ö†Ô∏è HandlePlayerAnswer called in invalid state. Player: {playerNumber}, HasFinished: {(playerNumber == 1 ? Player1HasFinished : Player2HasFinished)}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in HandlePlayerAnswer: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in HandlePlayerAnswer: {ex.Message}");
        }
    }
    
    private void ShowFeedbackThenAdvance(int playerNumber)
    {
        // Show feedback for 1 second, then advance to next question
        feedbackTimer = new Timer(1000);
        feedbackTimer.Elapsed += (sender, e) => 
        {
            InvokeAsync(() => {
                if (playerNumber == 1)
                {
                    Player1FeedbackVisible = false;
                    Player1Selections.Clear();
                    Player1QuestionIndex++;
                    
                    if (Player1QuestionIndex >= GameState.CurrentGame.Player1Questions.Count)
                    {
                        Player1HasFinished = true;
                        CalculateTimeBonus(playerNumber);
                    }
                }
                else
                {
                    Player2FeedbackVisible = false;
                    Player2Selections.Clear();
                    Player2QuestionIndex++;
                    
                    if (Player2QuestionIndex >= GameState.CurrentGame.Player2Questions.Count)
                    {
                        Player2HasFinished = true;
                        CalculateTimeBonus(playerNumber);
                    }
                }
                
                // Check if both players have finished
                if (Player1HasFinished && Player2HasFinished)
                {
                    EndGame();
                }
                
                StateHasChanged();
            });
            
            feedbackTimer.Dispose();
        };
        feedbackTimer.AutoReset = false;
        feedbackTimer.Enabled = true;
    }
    
    private void CalculateTimeBonus(int playerNumber)
    {
        // Calculate time bonus based on remaining time (max 3 points)
        int bonus = Math.Min(3, (int)Math.Ceiling(TimeRemaining / 20.0));
        
        if (playerNumber == 1)
            Player1TimeBonus = bonus;
        else
            Player2TimeBonus = bonus;
    }
    
    private void EndGame()
    {
        // Stop timers
        gameTimer?.Stop();
        feedbackTimer?.Stop();
        
        // Calculate final scores if players haven't finished
        if (!Player1HasFinished)
        {
            Player1HasFinished = true;
            CalculateTimeBonus(1);
        }
        
        if (!Player2HasFinished)
        {
            Player2HasFinished = true;
            CalculateTimeBonus(2);
        }
        
        // Update game session with results
        GameState.CurrentGame.Player1Score = Player1Score + Player1TimeBonus;
        GameState.CurrentGame.Player2Score = Player2Score + Player2TimeBonus;
        GameState.CurrentGame.EndTime = DateTime.UtcNow;
        
        // Save game results
        GameSessionService.SaveGameResultsAsync(GameState.CurrentGame);
        
        // Update UI to show both players have finished
        StateHasChanged();
    }
    
    [JSInvokable]
    public void HandleSwipe(string direction)
    {
        Logger.LogInformation("Swipe detected: {Direction}", direction);
        // Handle swipe actions if needed
    }
    
    public void Dispose()
    {
        try
        {
            Logger.LogInformation("‚ôªÔ∏è Disposing GameBoard component at {Time}", DateTime.Now);
            Console.WriteLine($"‚ôªÔ∏è Disposing GameBoard component at {DateTime.Now}");
            
            // Unsubscribe from connection state changes
            ConnectionState.ConnectionChanged -= HandleConnectionChanged;
            
            gameTimer?.Stop();
            gameTimer?.Dispose();
            feedbackTimer?.Stop();
            feedbackTimer?.Dispose();
            reconnectTimer?.Stop();
            reconnectTimer?.Dispose();
            
            // Dispose of the .NET object reference
            objRef?.Dispose();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error in Dispose: {Message}", ex.Message);
            Console.WriteLine($"‚ùå Error in Dispose: {ex.Message}");
        }
    }
}