# ProductSpec — PRD + Success Metrics

## Executive Summary

**PoFunQuiz** is a real-time, AI-powered quiz web application built on .NET 10 Blazor Server, deployed to Azure App Service. It allows one or two players to compete in trivia challenges across 8 categories, with questions generated on-demand by Azure OpenAI GPT-4o. Scores are persisted to a global leaderboard backed by Azure Table Storage.

**Business Goal:** Demonstrate a production-grade Blazor application integrating AI generative content, real-time multiplayer via SignalR, and cloud-native Azure deployment — serving as a reference implementation for the Po-prefixed solution family.

---

## Problem Statement

Traditional quiz apps use static question banks that become stale and repetitive. Players disengage quickly. There is no lightweight, serverless-friendly alternative that combines:
- Dynamic AI-generated content per session
- Real-time competitive multiplayer
- Persistent scoring without heavy infrastructure (no SQL server required)

---

## Target Users

| Persona | Description | Primary Need |
|---------|-------------|--------------|
| Casual Player | Plays solo for 5-10 minutes | Fresh, varied questions; immediate feedback |
| Competitive Player | Wants to beat friends | Multiplayer with live score sync |
| Leaderboard Chaser | High score motivation | Persistent rankings per category |
| Developer | Reference implementation | Clean architecture, Azure integration patterns |

---

## Features

### F1 — Solo Quiz Mode
- Player selects category (8 options) and difficulty (Easy/Medium/Hard)
- 10 questions generated by GPT-4o per session
- Multiple-choice (4 options) per question
- Timed responses with speed bonus
- Scoring: Base + Streak + Speed + Time bonus
- Results screen with breakdown

### F2 — Multiplayer Mode (2 players)
- Host creates game, receives 4-character game code
- Guest joins by entering game code
- Both players receive independent question sets (same category/difficulty)
- Real-time score sync via SignalR WebSocket
- Host-only start authority (auth enforced in GameHub)
- Win/loss/tie determination at game end

### F3 — Leaderboard
- Per-category top-10 scores
- Scores persist in Azure Table Storage
- Submitted at game end (optional)
- Fields: PlayerName, Score, MaxStreak, Category, DatePlayed, Wins, Losses

### F4 — Observability
- `/health` endpoint: JSON status for OpenAI and TableStorage health checks
- `/diag` endpoint: masked config/secrets dump for debugging
- Serilog structured logging → Console + rolling file + Application Insights
- OpenTelemetry traces + metrics → Azure Monitor

### F5 — Security
- Content-Security-Policy header on all responses
- Server-side input validation and HTML sanitization for player names
- Score clamping (max 10,000) to prevent injection attacks
- Secrets via Azure Key Vault (Managed Identity — no stored credentials)
- HTTPS-only in production (HSTS enforced)

---

## Categories

```
General | Science | History | Geography | Technology | Sports | Entertainment | Arts
```

---

## Scoring Model

| Component | Formula |
|-----------|---------|
| Base Score | Difficulty × correct answers (Easy=1, Medium=2, Hard=3) |
| Streak Bonus | +`streak` points per consecutive correct answer |
| Speed Bonus | Faster answers earn more points |
| Time Bonus | Remaining time converted to bonus points |
| **Total** | **BaseScore + StreakBonus + SpeedBonus + TimeBonus** |
| Max Score | 10,000 (capped on submission) |

---

## Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Question generation latency | < 3 seconds p95 | App Insights traces on `/api/quiz/questions` |
| Quiz completion rate | > 70% | Sessions with EndTime set vs total sessions |
| Leaderboard write success rate | > 99.9% | HTTP 201 rate on `POST /api/leaderboard` |
| App availability | > 99.5% uptime | App Service health check + Azure Monitor alerts |
| SignalR multiplayer session success | > 95% join success | `JoinGameResult.Success` rate |
| Health check pass rate | 100% | `/health` endpoint |

---

## Constraints & Decisions

| Decision | Rationale |
|----------|-----------|
| Blazor Server (not WASM) | Lower initial load, full .NET 10 APIs on server, no CORS issues |
| Azure Table Storage (not SQL) | Cost-effective, schema-less, sufficient for leaderboard at scale |
| In-memory multiplayer sessions | Low latency, no DB required for transient game state; SessionReaperService handles TTL |
| Output cache on quiz questions | 60-second cache reduces OpenAI API costs for popular category combos |
| No authentication | Anonymous play lowers friction; PlayerName is self-reported |
| GPT-4o deployment | Highest quality question generation; configurable via Key Vault |

---

## Out of Scope (v1)

- User authentication / accounts
- More than 2 players per game
- Question history / deduplication across sessions
- Custom question sets
- Mobile native apps
- Payment / monetization
