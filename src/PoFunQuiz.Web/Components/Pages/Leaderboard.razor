@page "/leaderboard"
@using PoFunQuiz.Web.Models
@using PoFunQuiz.Web.Components.Shared
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Sections
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Leaderboard - PoFunQuiz</PageTitle>

<SectionContent SectionName="HeaderContent">
    <div class="d-flex align-items-center">
        <span class="material-icons me-2" style="font-size: 1.2rem;">emoji_events</span>
        <span class="app-title">Leaderboard</span>
    </div>
</SectionContent>

<div class="container mt-4">
    <RadzenText TextStyle="TextStyle.H3" TextAlign="TextAlign.Center" class="rz-mb-4 rz-color-primary">üèÜ Hall of Fame</RadzenText>

    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
             <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenLabel Text="Category:" />
                    <RadzenDropDown TValue="string" Value=@currentCategory Data=@categories Change=@OnCategoryChanged Style="width: 100%;" />
                </RadzenStack>
            </RadzenCard>
        </div>
    </div>

    @if (isLoading)
    {
         <div class="rz-display-flex rz-flex-column rz-align-items-center rz-my-4">
            <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">Loading Leaderboard...</RadzenText>
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px; height: 4px;" />
            
            <!-- Skeleton Loading UI -->
            <div style="width: 100%; max-width: 800px; margin-top: 2rem;">
                @for(int i=0; i<5; i++)
                {
                    <div class="rz-display-flex rz-align-items-center rz-mb-3" style="opacity: @(1.0 - (i*0.15))">
                        <SkeletonLoader Style="width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem;" />
                        <SkeletonLoader Style="flex: 1; height: 24px; border-radius: 4px;" />
                        <SkeletonLoader Style="width: 80px; height: 24px; border-radius: 4px; margin-left: 1rem;" />
                    </div>
                }
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="empty-state">
            <span class="material-icons" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 0.5rem;">cloud_off</span>
            <h3 class="empty-title">@errorMessage</h3>
            <RadzenButton Text="Retry" Icon="refresh" ButtonStyle="ButtonStyle.Primary"
                          Style="border-radius: var(--radius-input); padding: 0.75rem 2rem; font-weight: 600; margin-top: 0.75rem;"
                          Click="@(async () => await LoadScores())" />
        </div>
    }
    else if (scores == null || !scores.Any())
    {
        <div class="empty-state">
            <svg class="empty-trophy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" width="100" height="100">
                <defs>
                    <linearGradient id="trophyGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fbbf24" />
                        <stop offset="100%" style="stop-color:#f59e0b" />
                    </linearGradient>
                </defs>
                <path d="M35 25h50v5c0 15-10 30-25 35-15-5-25-20-25-35v-5z" fill="url(#trophyGrad)" opacity="0.85"/>
                <path d="M35 30c-8 0-15 5-15 15s7 15 15 15" fill="none" stroke="#fbbf24" stroke-width="4" stroke-linecap="round" opacity="0.7"/>
                <path d="M85 30c8 0 15 5 15 15s-7 15-15 15" fill="none" stroke="#fbbf24" stroke-width="4" stroke-linecap="round" opacity="0.7"/>
                <rect x="50" y="65" width="20" height="12" rx="2" fill="#d97706" opacity="0.7"/>
                <rect x="40" y="77" width="40" height="10" rx="4" fill="#92400e" opacity="0.5"/>
                <circle cx="60" cy="45" r="8" fill="#fff" opacity="0.3"/>
            </svg>
            <h3 class="empty-title">No champions yet!</h3>
            <p class="empty-sub">Play a game to claim the top spot on the leaderboard.</p>
            <RadzenButton Text="Play Now" Icon="play_arrow" ButtonStyle="ButtonStyle.Primary"
                          Style="border-radius: var(--radius-input); padding: 0.75rem 2rem; font-weight: 600;"
                          Click="@(() => Navigation.NavigateTo("/"))" />
        </div>
    }
    else
    {
        <RadzenDataGrid Data="@scores" TItem="LeaderboardEntry" AllowSorting="true" AllowPaging="true" PageSize="10" Class="glass-card">
            <Columns>
                <RadzenDataGridColumn TItem="LeaderboardEntry" Title="Rank" Width="80px">
                    <Template Context="data">
                        @(scores.IndexOf(data) + 1)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="PlayerName" Title="Player" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Score" Title="Score" SortOrder="SortOrder.Descending" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Wins" Title="Wins" Width="80px" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Losses" Title="Losses" Width="80px" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="MaxStreak" Title="Max Streak" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="DatePlayed" Title="Date">
                    <Template Context="data">
                        @data.DatePlayed.ToLocalTime().ToString("g")
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</div>

<style>
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 3rem 1rem;
        gap: 0.5rem;
    }

    .empty-trophy {
        margin-bottom: 0.75rem;
        opacity: 0.9;
    }

    .empty-title {
        font-size: 1.35rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
    }

    .empty-sub {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin: 0 0 0.75rem;
        max-width: 280px;
    }
</style>

@code {
    private List<LeaderboardEntry>? scores;
    private bool isLoading = true;
    private string? errorMessage;
    private string currentCategory = "General";
    private List<string> categories = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        categories = new List<string> { "General" };
        categories.AddRange(QuestionCategories.All.Where(c => c != "General"));
        await LoadScores();
    }

    private async Task OnCategoryChanged(object value)
    {
        currentCategory = value.ToString() ?? "General";
        await LoadScores();
    }

    private async Task LoadScores()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            if (Http.BaseAddress == null)
            {
                Http.BaseAddress = new Uri(Navigation.BaseUri);
            }
            scores = await Http.GetFromJsonAsync<List<LeaderboardEntry>>($"api/leaderboard?category={Uri.EscapeDataString(currentCategory)}");
        }
        catch (Exception ex)
        {
            errorMessage = "Could not load leaderboard. Please try again later.";
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
