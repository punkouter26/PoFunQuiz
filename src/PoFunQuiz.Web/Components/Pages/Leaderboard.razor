@page "/leaderboard"
@using PoFunQuiz.Web.Models
@using PoFunQuiz.Web.Components.Shared
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Sections
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Leaderboard> Logger
@rendermode InteractiveServer

<PageTitle>Leaderboard - PoFunQuiz</PageTitle>

<SectionContent SectionName="HeaderContent">
    <div class="d-flex align-items-center">
        <span class="material-icons me-2" style="font-size: 1.2rem;">emoji_events</span>
        <span class="app-title">Leaderboard</span>
    </div>
</SectionContent>

<div class="lb-container">
    <h2 class="lb-heading">üèÜ Hall of Fame</h2>

    <div class="lb-filter-row">
        <label class="lb-filter-label">Category</label>
        <RadzenDropDown TValue="string" Value=@currentCategory Data=@categories Change=@OnCategoryChanged Style="width: 220px; border-radius: 12px;" />
    </div>

    @if (isLoading)
    {
        <div class="lb-empty-state">
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 180px; height: 4px; margin-bottom: 2rem;" />
            <!-- Animated skeleton rows -->
            <div style="width: 100%; max-width: 640px;">
                @for(int i = 0; i < 5; i++)
                {
                    var opacity = 1.0 - (i * 0.15);
                    <div class="skeleton-row" style="opacity: @opacity">
                        <SkeletonLoader Style="width: 36px; height: 36px; border-radius: 50%;" />
                        <SkeletonLoader Style="flex: 1; height: 20px; border-radius: 6px;" />
                        <SkeletonLoader Style="width: 72px; height: 20px; border-radius: 6px;" />
                    </div>
                }
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="lb-empty-state">
            <span class="material-icons" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 0.5rem;">cloud_off</span>
            <h3 class="empty-title">@errorMessage</h3>
            <RadzenButton Text="Retry" Icon="refresh" ButtonStyle="ButtonStyle.Primary"
                          Style="border-radius: var(--radius-input); padding: 0.75rem 2rem; font-weight: 600; margin-top: 0.75rem;"
                          Click="@(async () => await LoadScores())" />
        </div>
    }
    else if (scores == null || !scores.Any())
    {
        <div class="lb-empty-state">
            <svg class="empty-trophy" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" width="100" height="100">
                <defs>
                    <linearGradient id="trophyGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fbbf24" />
                        <stop offset="100%" style="stop-color:#f59e0b" />
                    </linearGradient>
                </defs>
                <path d="M35 25h50v5c0 15-10 30-25 35-15-5-25-20-25-35v-5z" fill="url(#trophyGrad)" opacity="0.85"/>
                <path d="M35 30c-8 0-15 5-15 15s7 15 15 15" fill="none" stroke="#fbbf24" stroke-width="4" stroke-linecap="round" opacity="0.7"/>
                <path d="M85 30c8 0 15 5 15 15s-7 15-15 15" fill="none" stroke="#fbbf24" stroke-width="4" stroke-linecap="round" opacity="0.7"/>
                <rect x="50" y="65" width="20" height="12" rx="2" fill="#d97706" opacity="0.7"/>
                <rect x="40" y="77" width="40" height="10" rx="4" fill="#92400e" opacity="0.5"/>
                <circle cx="60" cy="45" r="8" fill="#fff" opacity="0.3"/>
            </svg>
            <h3 class="empty-title">No champions yet!</h3>
            <p class="empty-sub">Play a game to claim the top spot on the leaderboard.</p>
            <RadzenButton Text="Play Now" Icon="play_arrow" ButtonStyle="ButtonStyle.Primary"
                          Style="border-radius: var(--radius-input); padding: 0.75rem 2rem; font-weight: 600;"
                          Click="@(() => Navigation.NavigateTo("/"))" />
        </div>
    }
    else
    {
        <RadzenDataGrid Data="@scores" TItem="LeaderboardEntry" AllowSorting="true" AllowPaging="true" PageSize="10" Class="glass-card">
            <Columns>
                <RadzenDataGridColumn TItem="LeaderboardEntry" Title="Rank" Width="80px">
                    <Template Context="data">
                        @(scores.IndexOf(data) + 1)
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="PlayerName" Title="Player" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Score" Title="Score" SortOrder="SortOrder.Descending" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Wins" Title="Wins" Width="80px" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="Losses" Title="Losses" Width="80px" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="MaxStreak" Title="Max Streak" />
                <RadzenDataGridColumn TItem="LeaderboardEntry" Property="DatePlayed" Title="Date">
                    <Template Context="data">
                        @data.DatePlayed.ToLocalTime().ToString("g")
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</div>

<style>
    .lb-container {
        max-width: 860px;
        margin: 0 auto;
        padding: 1.5rem 1rem;
        padding-bottom: 90px;
    }

    .lb-heading {
        font-size: var(--text-3xl, 1.875rem);
        font-weight: 900;
        text-align: center;
        color: white;
        margin-bottom: 1.25rem;
        text-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .lb-filter-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .lb-filter-label {
        font-size: var(--text-sm, 0.875rem);
        font-weight: 600;
        color: rgba(255,255,255,0.85);
    }

    .lb-empty-state {
        min-height: 55vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem 1rem;
        gap: 0.5rem;
    }

    .skeleton-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.85rem;
        background: rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 0.75rem 1rem;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 3rem 1rem;
        gap: 0.5rem;
    }

    .empty-trophy {
        margin-bottom: 0.75rem;
        opacity: 0.9;
    }

    .empty-title {
        font-size: 1.35rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
    }

    .empty-sub {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin: 0 0 0.75rem;
        max-width: 280px;
    }
</style>

@code {
    private List<LeaderboardEntry>? scores;
    private bool isLoading = true;
    private string? errorMessage;
    private string currentCategory = "General";
    private List<string> categories = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        categories = new List<string> { "General" };
        categories.AddRange(QuestionCategories.All.Where(c => c != "General"));
        await LoadScores();
    }

    private async Task OnCategoryChanged(object value)
    {
        currentCategory = value.ToString() ?? "General";
        await LoadScores();
    }

    private async Task LoadScores()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            if (Http.BaseAddress == null)
            {
                Http.BaseAddress = new Uri(Navigation.BaseUri);
            }
            scores = await Http.GetFromJsonAsync<List<LeaderboardEntry>>($"api/leaderboard?category={Uri.EscapeDataString(currentCategory)}");
        }
        catch (Exception ex)
        {
            errorMessage = "Could not load leaderboard. Please try again later.";
            Logger.LogError(ex, "Error loading leaderboard");
        }
        finally
        {
            isLoading = false;
        }
    }
}
